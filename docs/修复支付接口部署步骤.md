# 修复支付接口 422/400 - 部署步骤

全功能联调测试中，**创建会员订单** 返回 422、**创建报告订单（company）** 返回 400，是因为阿里云上的后端还未部署包含「会员订单类型」和「company/acceptance 资源类型」的最新代码。按下面步骤在阿里云更新并重启后端即可修复。

---

## 需要您协助的操作（在您本机 + 阿里云服务器）

### 第一步：确认本地已提交并推送

在您本机项目目录执行（若尚未推送过本次修改）：

```bash
cd /Users/mac/zhuangxiu-agent-backup-dev
git status
git add .
git commit -m "商业闭环：支付创建订单与 confirm-paid、报告详情 is_unlocked 同步"
git push
```

若已经 push 过，可跳过本步。

---

### 第二步：在阿里云服务器拉取并重启后端

1. **SSH 登录阿里云**（按您现有方式，例如）：

   ```bash
   ssh -i ~/zhuangxiu-agent1.pem root@120.26.201.61
   ```

2. **进入项目目录并拉取**（目录以您实际为准，常见为 `zhuangxiu-agent` 或与本地仓库对应的路径）：

   ```bash
   cd /root/project/dev/zhuangxiu-agent
   git pull
   ```

   若有冲突，按提示处理或联系我。

3. **重新构建并启动后端**（支付相关逻辑在 `backend/`，需要重建镜像并重启）：

   ```bash
   docker compose -f docker-compose.dev.yml build backend --no-cache
   docker compose -f docker-compose.dev.yml up -d backend
   ```

   若没有 `docker-compose.dev.yml`，请用您实际使用的 compose 文件，例如：

   ```bash
   docker compose build backend --no-cache
   docker compose up -d backend
   ```

4. **（可选）看日志确认启动成功**：

   ```bash
   docker compose -f docker-compose.dev.yml logs -f backend
   # 或
   docker logs -f zhuangxiu-backend-dev
   ```

   看到服务正常监听后按 `Ctrl+C` 退出。

---

### 第三步：本地再次跑全功能测试验证

在您本机执行：

```bash
cd /Users/mac/zhuangxiu-agent-backup-dev
python tests/test_all_features_comprehensive.py
```

- 若部署成功，**创建会员订单** 和 **创建报告订单（company）** 应不再出现 422/400，测试里也不会再出现那两条警告。
- 若仍有 422/400，请把完整测试输出（或至少 11. 支付模块 那一段）发给我，我帮您对一下接口和请求体。

---

## 小结

| 步骤 | 谁做 | 做什么 |
|------|------|--------|
| 1 | 您（本机） | 确认代码已 `git push` |
| 2 | 您（阿里云） | SSH → `cd 项目` → `git pull` → `docker compose build backend --no-cache` → `up -d backend` |
| 3 | 您（本机） | 运行 `python tests/test_all_features_comprehensive.py` 验证 |

完成以上三步后，支付相关 422/400 即可修复。若执行某一步时遇到报错或与您环境不一致（路径、compose 文件名等），把报错或实际命令发给我，我按您环境改一版。
