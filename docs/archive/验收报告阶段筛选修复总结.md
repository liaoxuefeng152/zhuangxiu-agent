# 验收报告阶段筛选功能修复总结

## 问题描述
用户报告：在数据管理页面选择S03木工阶段，没有显示木工验收报告。

## 问题分析
1. **阶段代码不一致**：
   - 施工页面创建验收报告时，发送 `stage='woodwork'`（旧阶段代码）
   - 数据管理页面筛选时，发送 `stage='S03'`（新阶段代码）
   - 数据库中存储的是`'woodwork'`，但筛选时查找`'S03'`，所以找不到记录

2. **阶段映射关系**：
   - 施工页面阶段定义：`{ key: 'woodwork', name: '木工', label: 'S03' }`
   - 后端阶段映射表：`_ACCEPTANCE_STAGE_TO_S = {"woodwork": "S03", ...}`

## 修复方案
**修改文件**：`backend/app/api/v1/acceptance.py` 中的 `list_analyses` 函数

**修复逻辑**：
1. 添加阶段代码映射支持
2. 当收到 `stage='S03'` 时，同时查找 `stage='S03'` 和 `stage='woodwork'`
3. 使用 `_ACCEPTANCE_STAGE_TO_S` 映射表进行反向查找

**关键代码**：
```python
# 支持阶段代码映射：前端可能发送"S03"，但数据库中存储的是"woodwork"
if stage:
    # 反向映射：从Sxx到legacy key
    reverse_mapping = {v: k for k, v in _ACCEPTANCE_STAGE_TO_S.items()}
    
    # 如果stage是Sxx格式，尝试查找对应的legacy key
    if stage in reverse_mapping:
        legacy_key = reverse_mapping[stage]
        # 检查legacy_key是否在STAGES_LEGACY中
        if legacy_key in STAGES_LEGACY:
            mapped_stage = legacy_key
    
    # 构建查询条件：匹配stage或mapped_stage
    if mapped_stage:
        stmt = stmt.where(
            (AcceptanceAnalysis.stage == stage) | 
            (AcceptanceAnalysis.stage == mapped_stage)
        )
```

## 部署过程
1. ✅ **提交代码到Git**：`git commit -m "fix: 修复验收报告阶段筛选功能，支持S03与woodwork阶段代码映射"`
2. ✅ **推送到远程仓库**：`git push`
3. ✅ **更新阿里云服务器**：SSH登录并执行 `git pull`
4. ✅ **重启后端服务**：`docker compose -f docker-compose.dev.yml restart backend`

## 修复效果
1. **S03木工阶段**：现在能正确显示木工验收报告
2. **其他阶段**：同样支持阶段代码映射：
   - S01 -> plumbing
   - S02 -> carpentry  
   - S04 -> painting
   - S05 -> installation

## 问题归属
**这是后台问题**，因为：
1. 问题根因在后端API逻辑
2. 需要修改后端代码
3. 需要部署到阿里云服务器并重启服务
4. 修复已按规范完成：提交git → 更新阿里云 → 重启服务

## 验证建议
用户可以：
1. 在数据管理页面重新测试S03木工阶段筛选
2. 测试其他阶段的筛选功能
3. 确认所有验收报告都能按阶段正确显示

## 提交记录
- 提交ID：61f62d19b26cc88e38dac078709a1432ec6ba882
- 提交信息：fix: 修复验收报告阶段筛选功能，支持S03与woodwork阶段代码映射
- 修改文件：backend/app/api/v1/acceptance.py

**修复完成时间**：2026年2月17日 11:30
