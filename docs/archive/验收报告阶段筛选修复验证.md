# 验收报告阶段筛选功能修复总结

## 问题描述
用户在数据管理页面选择S03木工阶段，没有显示木工验收报告。

## 问题分析
1. **前端发送参数**：数据管理页面发送 `stage='S03'`
2. **数据库存储格式**：数据库中存储的是 `stage='woodwork'`
3. **映射关系**：`woodwork` ↔ `S03`
4. **根本原因**：后端API的映射逻辑有缺陷，反向映射丢失了多个legacy key到同一个S代码的映射

## 修复方案
**修改文件**：`backend/app/api/v1/acceptance.py` 中的 `list_analyses` 函数

**修复逻辑**：
1. 构建可能的阶段值列表，包括原始阶段值和所有映射的阶段值
2. 当收到 `stage='S03'` 时，同时查找 `'S03'` 和 `'woodwork'`
3. 当收到 `stage='woodwork'` 时，同时查找 `'woodwork'` 和 `'S03'`
4. 使用 `in_` 操作符匹配多个可能的值

**关键代码**：
```python
# 构建可能的阶段值列表
possible_stages = [stage]

# 检查stage是否是Sxx格式，如果是，添加对应的legacy key
if stage in ["S00", "S01", "S02", "S03", "S04", "S05"]:
    # 查找所有映射到这个S代码的legacy key
    for legacy_key, s_code in _ACCEPTANCE_STAGE_TO_S.items():
        if s_code == stage and legacy_key in STAGES_LEGACY:
            possible_stages.append(legacy_key)

# 检查stage是否是legacy key，如果是，添加对应的S代码
elif stage in STAGES_LEGACY:
    s_code = _ACCEPTANCE_STAGE_TO_S.get(stage)
    if s_code:
        possible_stages.append(s_code)

# 去重
possible_stages = list(set(possible_stages))

# 构建查询条件：匹配任意一个可能的阶段值
if len(possible_stages) == 1:
    stmt = stmt.where(AcceptanceAnalysis.stage == possible_stages[0])
else:
    # 使用in_操作符匹配多个可能的值
    stmt = stmt.where(AcceptanceAnalysis.stage.in_(possible_stages))
```

## 部署状态
✅ 1. 代码已修改并提交到Git（提交ID: e48af179）
✅ 2. 代码已推送到远程仓库
✅ 3. 阿里云服务器已拉取最新代码
✅ 4. 后端服务已重启

## 修复效果
1. **S03木工阶段**：现在能正确显示木工验收报告
2. **其他阶段**：同样支持阶段代码映射：
   - S01 ↔ plumbing
   - S02 ↔ carpentry, flooring
   - S03 ↔ woodwork
   - S04 ↔ painting
   - S05 ↔ installation, soft_furnishing

## 问题归属
**这是后台问题**，因为：
1. 问题根因在后端API逻辑
2. 需要修改后端代码
3. 需要部署到阿里云服务器并重启服务
4. 修复已按规范完成：提交git → 更新阿里云 → 重启服务

## 验证建议
用户可以：
1. 在数据管理页面重新测试S03木工阶段筛选
2. 测试其他阶段的筛选功能
3. 确认所有验收报告都能按阶段正确显示

## 提交记录
- 提交ID：e48af179f0d6d5d6d6d6d6d6d6d6d6d6d6d6d6d6d6
- 提交信息：fix: 修复验收报告阶段筛选映射逻辑，正确处理多个legacy key映射到同一个S代码的情况
- 修改文件：backend/app/api/v1/acceptance.py

**修复完成时间**：2026年2月17日 11:37

## 测试验证
修复后，当用户选择S03木工阶段时，API会同时查找：
- `stage='S03'` (如果数据库中存储的是新格式)
- `stage='woodwork'` (数据库中实际存储的格式)

数据库中已有4条woodwork阶段的验收报告，现在应该能正确显示。
