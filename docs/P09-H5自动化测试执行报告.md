# P09 施工陪伴页 H5 自动化测试执行报告

**执行时间**：2026-02-15  
**测试环境**：H5 版本（Taro）+ 阿里云后端 API

---

## 一、已完成的准备工作

### 1. H5 开发服务器

- **状态**：可正常启动
- **启动命令**：`cd frontend && TARO_APP_API_BASE_URL=http://120.26.201.61:8001/api/v1 npm run dev:h5:local`
- **访问地址**：http://localhost:10086（若被占用则自动切到 10087）
- **验证**：编译成功，webpack-dev-server 正常监听

### 2. Playwright E2E 测试脚本

- **位置**：`tests/e2e-p09-construction.spec.ts`
- **覆盖用例**：
  - TC-P09-001：未设置开工日期时展示设置区域
  - TC-P09-005：顶部导航栏含施工陪伴标题
  - TC-P09-040：点击提醒设置打开弹窗
  - TC-P09-104：TabBar 含施工陪伴
  - TC-P09-010：快捷选择 7 天后开工

### 3. 配置文件

- **Playwright 配置**：`playwright.config.ts`（视口 375×667，模拟手机）

---

## 二、执行步骤（需本地执行）

因沙箱环境无法启动 Playwright 浏览器，请在本机终端执行：

```bash
# 1. 安装 Playwright 浏览器（仅首次）
cd /Users/mac/zhuangxiu-agent-backup-dev
npx playwright install chromium

# 2. 启动 H5 开发服务器（终端 1）
cd frontend && TARO_APP_API_BASE_URL=http://120.26.201.61:8001/api/v1 npm run dev:h5:local

# 3. 运行 P09 自动化测试（终端 2，确认 H5 已启动）
cd /Users/mac/zhuangxiu-agent-backup-dev
P09_H5_URL=http://localhost:10086 npx playwright test tests/e2e-p09-construction.spec.ts

# 若端口为 10087，则：
P09_H5_URL=http://localhost:10087 npx playwright test tests/e2e-p09-construction.spec.ts
```

---

## 三、可扩展的测试用例

可在 `tests/e2e-p09-construction.spec.ts` 中继续补充：

| 编号 | 用例 | 自动化可行性 | 备注 |
|------|------|--------------|------|
| TC-P09-004 | 6 阶段卡片展示 | ✅ | 需先设置开工日期 |
| TC-P09-022/023 | S00 入口管控 | ✅ | 需已上传报价单 |
| TC-P09-030~035 | 流程互锁 | ✅ | 需配合后端状态 |
| TC-P09-041~043 | 提醒设置交互 | ✅ | |
| TC-P09-080 | 一键分享跳转 | ✅ | |
| TC-P09-001/002 | 加载状态 | ⚠️ | 需清缓存模拟新用户 |
| TC-P09-050~055 | 时间校准 | ⚠️ | 涉及 Picker 组件 |
| 拍照/上传相关 | - | ❌ | H5 与小程序实现不同 |

---

## 四、限制说明

1. **H5 与小程序差异**：部分能力（如 `Taro.chooseImage`）在 H5 上行为可能不同。
2. **登录**：测试脚本当前未包含登录流程，若页面需要登录才能访问施工陪伴，需先补充登录步骤或使用开发环境 mock 登录。
3. **端口**：H5 默认 10086，被占用时会切到 10087，执行测试前请确认实际端口。

---

## 五、P30 验收报告页「未解锁」态测试（V2.6.4）

若验收报告页始终显示全部内容、全部「查看详情」，说明 `unlocked` 被误判为 true（会员或已解锁记录在 Storage）。可按以下方式验证未解锁态：

1. **强制锁定**：在 URL 后加 `&forceLock=1`，例如：`/pages/acceptance/index?stage=plumbing&forceLock=1`
2. **清除缓存**：微信开发者工具 → 清除缓存 → 清除数据缓存，或删除 Storage 中的 `is_member`、`report_unlocked_acceptance_${stage}`
3. **非会员账号**：使用未开通会员的账号测试

---

## 六、结论

- **自动化基础**：H5 服务可正常启动，Playwright 测试脚本已编写并可扩展。
- **执行环境**：需在本地完成 `npx playwright install chromium` 后再运行测试。
- **后续**：可按测试用例文档继续补充用例，并视需要增加登录、清缓存等前置步骤。
