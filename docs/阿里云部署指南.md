# é˜¿é‡Œäº‘éƒ¨ç½²æŒ‡å—

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•å°†è£…ä¿®å†³ç­–Agentåç«¯éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨ï¼ŒåŒ…æ‹¬æ„å»ºã€éƒ¨ç½²å’Œé‡å¯æµç¨‹ã€‚

## å‰ç½®æ¡ä»¶

1. **é˜¿é‡Œäº‘ECSæœåŠ¡å™¨**
   - æ¨èé…ç½®ï¼š2æ ¸4GBä»¥ä¸Š
   - æ“ä½œç³»ç»Ÿï¼šUbuntu 20.04+ æˆ– CentOS 7+
   - å·²å®‰è£… Docker å’Œ Docker Compose

2. **å¤–éƒ¨æœåŠ¡**
   - PostgreSQL æ•°æ®åº“ï¼ˆå¯ä½¿ç”¨é˜¿é‡Œäº‘RDSï¼‰
   - Redis ç¼“å­˜ï¼ˆå¯ä½¿ç”¨é˜¿é‡Œäº‘Redisï¼‰

3. **ç¯å¢ƒé…ç½®**
   - å·²é…ç½® `.env` æ–‡ä»¶ï¼ˆå‚è€ƒ `.env.example`ï¼‰
   - ç¡®ä¿æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡å·²è®¾ç½®

## å¿«é€Ÿéƒ¨ç½²

### 1. é¦–æ¬¡éƒ¨ç½²

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /path/to/zhuangxiu-agent

# 2. ç¡®ä¿ .env æ–‡ä»¶å·²é…ç½®
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥å®é™…é…ç½®

# 3. ç»™éƒ¨ç½²è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x scripts/deploy-aliyun.sh
chmod +x scripts/restart-backend.sh

# 4. æ‰§è¡Œéƒ¨ç½²ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
./scripts/deploy-aliyun.sh prod

# æˆ–éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
./scripts/deploy-aliyun.sh dev
```

### 2. æ›´æ–°ä»£ç åé‡æ–°éƒ¨ç½²

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 2. é‡æ–°æ„å»ºå¹¶éƒ¨ç½²
./scripts/deploy-aliyun.sh prod
```

### 3. ä»…é‡å¯æœåŠ¡ï¼ˆä¸é‡æ–°æ„å»ºï¼‰

```bash
# é‡å¯ç”Ÿäº§ç¯å¢ƒ
./scripts/restart-backend.sh prod

# é‡å¯å¼€å‘ç¯å¢ƒ
./scripts/restart-backend.sh dev
```

## æ‰‹åŠ¨éƒ¨ç½²æ­¥éª¤

å¦‚æœä¸æƒ³ä½¿ç”¨è„šæœ¬ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

### 1. æ„å»ºé•œåƒ

```bash
# æ„å»ºåç«¯é•œåƒ
docker-compose -f docker-compose.prod.yml build --no-cache backend
```

### 2. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨æœåŠ¡
docker-compose -f docker-compose.prod.yml up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f backend
```

### 3. é‡å¯æœåŠ¡

```bash
# é‡å¯åç«¯
docker-compose -f docker-compose.prod.yml restart backend

# æˆ–åœæ­¢åé‡æ–°å¯åŠ¨
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml up -d
```

## ç¯å¢ƒé…ç½®è¯´æ˜

### ç”Ÿäº§ç¯å¢ƒ (prod)

- **é…ç½®æ–‡ä»¶**: `docker-compose.prod.yml`
- **ç«¯å£**: 8000
- **å·¥ä½œè¿›ç¨‹**: 4ä¸ª worker
- **è°ƒè¯•æ¨¡å¼**: å…³é—­
- **è®¿é—®åœ°å€**: `http://your-server-ip:8000`

### å¼€å‘ç¯å¢ƒ (dev)

- **é…ç½®æ–‡ä»¶**: `docker-compose.server-dev.yml`
- **ç«¯å£**: 8001
- **å·¥ä½œè¿›ç¨‹**: 1ä¸ª worker
- **è°ƒè¯•æ¨¡å¼**: å¼€å¯
- **è®¿é—®åœ°å€**: `http://your-server-ip:8001`

## ç¯å¢ƒå˜é‡é…ç½®

ç¡®ä¿ `.env` æ–‡ä»¶åŒ…å«ä»¥ä¸‹å¿…éœ€é…ç½®ï¼š

```env
# æ•°æ®åº“é…ç½®ï¼ˆä½¿ç”¨é˜¿é‡Œäº‘RDSåœ°å€ï¼‰
DATABASE_URL=postgresql+asyncpg://user:password@your-rds-host:5432/zhuangxiu_prod

# Redisé…ç½®ï¼ˆä½¿ç”¨é˜¿é‡Œäº‘Redisåœ°å€ï¼‰
REDIS_URL=redis://your-redis-host:6379/0
REDIS_PASSWORD=your-redis-password

# å¾®ä¿¡å°ç¨‹åºé…ç½®
WECHAT_APP_ID=your_app_id
WECHAT_APP_SECRET=your_app_secret

# é˜¿é‡Œäº‘é…ç½®
ALIYUN_ACCESS_KEY_ID=your_access_key_id
ALIYUN_ACCESS_KEY_SECRET=your_access_key_secret
ALIYUN_OSS_BUCKET=your_bucket_name

# AIåˆ†æé…ç½®ï¼ˆä¸‰é€‰ä¸€ï¼‰
COZE_SITE_URL=https://your-coze-site.coze.site
COZE_SITE_TOKEN=your_token
COZE_PROJECT_ID=your_project_id

# å…¶ä»–é…ç½®...
```

## å¸¸ç”¨å‘½ä»¤

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f backend

# æŸ¥çœ‹æœ€è¿‘100è¡Œæ—¥å¿—
docker-compose -f docker-compose.prod.yml logs --tail=100 backend
```

### å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
curl http://localhost:8000/health

# æˆ–ä½¿ç”¨æµè§ˆå™¨è®¿é—®
# http://your-server-ip:8000/health
```

### è¿›å…¥å®¹å™¨è°ƒè¯•

```bash
# è¿›å…¥åç«¯å®¹å™¨
docker exec -it zhuangxiu-backend-prod bash

# æŸ¥çœ‹Pythonè¿›ç¨‹
docker exec -it zhuangxiu-backend-prod ps aux
```

### æ¸…ç†èµ„æº

```bash
# åœæ­¢å¹¶åˆ é™¤å®¹å™¨
docker-compose -f docker-compose.prod.yml down

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨å’Œé•œåƒ
docker-compose -f docker-compose.prod.yml down --rmi local

# æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
docker image prune -a
```

## æ•…éšœæ’æŸ¥

### 1. æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs backend

# æ£€æŸ¥ç¯å¢ƒå˜é‡
docker exec zhuangxiu-backend-prod env | grep DATABASE_URL
```

### 2. æ•°æ®åº“è¿æ¥å¤±è´¥

- æ£€æŸ¥ `.env` ä¸­çš„ `DATABASE_URL` æ˜¯å¦æ­£ç¡®
- ç¡®è®¤æ•°æ®åº“æœåŠ¡å¯è®¿é—®ï¼ˆæ£€æŸ¥é˜²ç«å¢™è§„åˆ™ï¼‰
- éªŒè¯æ•°æ®åº“ç”¨æˆ·æƒé™

### 3. Redisè¿æ¥å¤±è´¥

- æ£€æŸ¥ `.env` ä¸­çš„ `REDIS_URL` å’Œ `REDIS_PASSWORD`
- ç¡®è®¤RedisæœåŠ¡å¯è®¿é—®
- éªŒè¯Rediså¯†ç æ˜¯å¦æ­£ç¡®

### 4. ç«¯å£è¢«å ç”¨

```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -tulpn | grep 8000
# æˆ–
lsof -i :8000

# ä¿®æ”¹ docker-compose.prod.yml ä¸­çš„ç«¯å£æ˜ å°„
```

### 5. é•œåƒæ„å»ºå¤±è´¥

```bash
# æ¸…ç†æ„å»ºç¼“å­˜åé‡æ–°æ„å»º
docker-compose -f docker-compose.prod.yml build --no-cache --pull backend
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å·¥ä½œè¿›ç¨‹æ•°**: æ ¹æ®æœåŠ¡å™¨CPUæ ¸å¿ƒæ•°è°ƒæ•´ `--workers` å‚æ•°
   - 2æ ¸: `--workers 2`
   - 4æ ¸: `--workers 4`
   - 8æ ¸: `--workers 8`

2. **æ•°æ®åº“è¿æ¥æ± **: åœ¨ `.env` ä¸­é…ç½®
   ```env
   DATABASE_POOL_SIZE=20
   DATABASE_MAX_OVERFLOW=10
   ```

3. **æ—¥å¿—ç®¡ç†**: å·²é…ç½®æ—¥å¿—è½®è½¬ï¼ˆæœ€å¤§10MBï¼Œä¿ç•™3ä¸ªæ–‡ä»¶ï¼‰

4. **å¥åº·æ£€æŸ¥**: å·²é…ç½®è‡ªåŠ¨å¥åº·æ£€æŸ¥ï¼Œå®¹å™¨å¼‚å¸¸ä¼šè‡ªåŠ¨é‡å¯

## å®‰å…¨å»ºè®®

1. **é˜²ç«å¢™é…ç½®**: åªå¼€æ”¾å¿…è¦ç«¯å£ï¼ˆ8000ï¼‰
   ```bash
   # Ubuntu/Debian
   sudo ufw allow 8000/tcp
   
   # CentOS/RHEL
   sudo firewall-cmd --add-port=8000/tcp --permanent
   sudo firewall-cmd --reload
   ```

2. **ä½¿ç”¨HTTPS**: å»ºè®®ä½¿ç”¨Nginxåå‘ä»£ç†å¹¶é…ç½®SSLè¯ä¹¦

3. **ç¯å¢ƒå˜é‡å®‰å…¨**: ç¡®ä¿ `.env` æ–‡ä»¶æƒé™è®¾ç½®æ­£ç¡®
   ```bash
   chmod 600 .env
   ```

4. **å®šæœŸæ›´æ–°**: å®šæœŸæ›´æ–°Dockeré•œåƒå’Œç³»ç»Ÿä¾èµ–

## ğŸš€ ç”Ÿäº§ç¯å¢ƒå®Œæ•´éƒ¨ç½²æŒ‡å—

### 1. ç”Ÿäº§ç¯å¢ƒæ¶æ„
```
ç”¨æˆ·è®¿é—® HTTPS (443) â†’ Nginx (åå‘ä»£ç†) â†’ åç«¯æœåŠ¡ (8000ç«¯å£)
           â†“
        SSLè¯ä¹¦ (lakeli.top)
           â†“
    é˜¿é‡Œäº‘ECSæœåŠ¡å™¨
```

### 2. ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶

#### 2.1 ç¯å¢ƒå˜é‡æ–‡ä»¶ (`.env.prod`)
ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸“ç”¨çš„ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼š
```bash
# ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒé…ç½®
cp .env.prod .env
# æˆ–ç›´æ¥ä½¿ç”¨
export ENV_FILE=.env.prod
```

#### 2.2 Nginxé…ç½® (`nginx/conf.d/prod.conf`)
ç”Ÿäº§ç¯å¢ƒNginxé…ç½®åŒ…å«ï¼š
- HTTPSé‡å®šå‘
- SSLè¯ä¹¦é…ç½®
- å®‰å…¨å¤´è®¾ç½®
- åå‘ä»£ç†åˆ°åç«¯æœåŠ¡

#### 2.3 Docker Composeé…ç½® (`docker-compose.prod.yml`)
ç”Ÿäº§ç¯å¢ƒDockeré…ç½®ï¼š
- ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒå˜é‡æ–‡ä»¶
- 4ä¸ªå·¥ä½œè¿›ç¨‹
- å¥åº·æ£€æŸ¥é…ç½®
- æ—¥å¿—è½®è½¬

### 3. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ­¥éª¤

#### 3.1 å‡†å¤‡å·¥ä½œ
```bash
# 1. ç¡®ä¿SSLè¯ä¹¦å·²å‡†å¤‡å¥½
ls -la nginx/ssl/
# åº”æœ‰ fullchain.pem å’Œ privkey.pem

# 2. é…ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡
cp .env.prod .env
# æ£€æŸ¥å…³é”®é…ç½®ï¼šæ•°æ®åº“ã€Redisã€å¾®ä¿¡å°ç¨‹åºã€é˜¿é‡Œäº‘OSSç­‰

# 3. ç¡®ä¿åŸŸåè§£ææ­£ç¡®
nslookup lakeli.top
nslookup www.lakeli.top
```

#### 3.2 æ‰§è¡Œéƒ¨ç½²
```bash
# æ–¹æ³•1: ä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰
./scripts/deploy-aliyun.sh prod

# æ–¹æ³•2: æ‰‹åŠ¨éƒ¨ç½²
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml build --no-cache backend
docker-compose -f docker-compose.prod.yml up -d
```

#### 3.3 é…ç½®Nginx
```bash
# 1. å¯åŠ¨Nginxå®¹å™¨ï¼ˆå¦‚æœä½¿ç”¨ç‹¬ç«‹çš„Nginxï¼‰
docker-compose -f docker-compose.prod.yml up -d nginx

# 2. æˆ–ä½¿ç”¨ç³»ç»ŸNginx
# å°† nginx/conf.d/prod.conf å¤åˆ¶åˆ° /etc/nginx/conf.d/
# é‡å¯Nginx: sudo systemctl restart nginx
```

#### 3.4 éªŒè¯éƒ¨ç½²
```bash
# 1. å¥åº·æ£€æŸ¥
curl -f https://lakeli.top/health

# 2. APIæ–‡æ¡£
curl -f https://lakeli.top/api/docs

# 3. SSLè¯ä¹¦éªŒè¯
openssl s_client -connect lakeli.top:443 -servername lakeli.top </dev/null 2>/dev/null | openssl x509 -noout -dates

# 4. å®‰å…¨å¤´æ£€æŸ¥
curl -I https://lakeli.top/health
```

### 4. Nginxåå‘ä»£ç†é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨Nginxé…ç½®HTTPSï¼š

```nginx
# å®Œæ•´é…ç½®è§: nginx/conf.d/prod.conf
server {
    listen 80;
    server_name lakeli.top www.lakeli.top;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name lakeli.top www.lakeli.top;
    
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    
    # å®‰å…¨å¤´é…ç½®
    add_header Strict-Transport-Security "max-age=63072000" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    
    location / {
        proxy_pass http://zhuangxiu-backend-prod:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 5. ç”Ÿäº§ç¯å¢ƒç›‘æ§å»ºè®®

1. **æ—¥å¿—ç›‘æ§**: ä½¿ç”¨ `docker logs` æˆ–æ—¥å¿—æ”¶é›†å·¥å…·ï¼ˆå¦‚ELKï¼‰
2. **æ€§èƒ½ç›‘æ§**: ç›‘æ§CPUã€å†…å­˜ã€æ•°æ®åº“è¿æ¥æ•°ç­‰æŒ‡æ ‡
3. **å¥åº·æ£€æŸ¥**: å®šæœŸæ£€æŸ¥ `/health` æ¥å£
4. **é”™è¯¯å‘Šè­¦**: é…ç½®é”™è¯¯æ—¥å¿—å‘Šè­¦æœºåˆ¶

## è”ç³»æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- APIæ–‡æ¡£: `http://your-server-ip:8000/api/docs`
- é¡¹ç›®README: `backend/README-DOCKER.md`
- æ—¥å¿—æ–‡ä»¶: `docker-compose logs`
