# 阿里云部署指南

本文档介绍如何将装修决策Agent后端部署到阿里云服务器，包括构建、部署和重启流程。

## 前置条件

1. **阿里云ECS服务器**
   - 推荐配置：2核4GB以上
   - 操作系统：Ubuntu 20.04+ 或 CentOS 7+
   - 已安装 Docker 和 Docker Compose

2. **外部服务**
   - PostgreSQL 数据库（可使用阿里云RDS）
   - Redis 缓存（可使用阿里云Redis）

3. **环境配置**
   - 已配置 `.env` 文件（参考 `.env.example`）
   - 确保所有必需的环境变量已设置

## 快速部署

### 1. 首次部署

```bash
# 1. 进入项目目录
cd /path/to/zhuangxiu-agent

# 2. 确保 .env 文件已配置
cp .env.example .env
# 编辑 .env 文件，填入实际配置

# 3. 给部署脚本添加执行权限
chmod +x scripts/deploy-aliyun.sh
chmod +x scripts/restart-backend.sh

# 4. 执行部署（生产环境）
./scripts/deploy-aliyun.sh prod

# 或部署到开发环境
./scripts/deploy-aliyun.sh dev
```

### 2. 更新代码后重新部署

```bash
# 1. 拉取最新代码
git pull origin main

# 2. 重新构建并部署
./scripts/deploy-aliyun.sh prod
```

### 3. 仅重启服务（不重新构建）

```bash
# 重启生产环境
./scripts/restart-backend.sh prod

# 重启开发环境
./scripts/restart-backend.sh dev
```

## 手动部署步骤

如果不想使用脚本，可以手动执行以下步骤：

### 1. 构建镜像

```bash
# 构建后端镜像
docker-compose -f docker-compose.prod.yml build --no-cache backend
```

### 2. 启动服务

```bash
# 启动服务
docker-compose -f docker-compose.prod.yml up -d

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f backend
```

### 3. 重启服务

```bash
# 重启后端
docker-compose -f docker-compose.prod.yml restart backend

# 或停止后重新启动
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml up -d
```

## 环境配置说明

### 生产环境 (prod)

- **配置文件**: `docker-compose.prod.yml`
- **端口**: 8000
- **工作进程**: 4个 worker
- **调试模式**: 关闭
- **访问地址**: `http://your-server-ip:8000`

### 开发环境 (dev)

- **配置文件**: `docker-compose.server-dev.yml`
- **端口**: 8001
- **工作进程**: 1个 worker
- **调试模式**: 开启
- **访问地址**: `http://your-server-ip:8001`

## 环境变量配置

确保 `.env` 文件包含以下必需配置：

```env
# 数据库配置（使用阿里云RDS地址）
DATABASE_URL=postgresql+asyncpg://user:password@your-rds-host:5432/zhuangxiu_prod

# Redis配置（使用阿里云Redis地址）
REDIS_URL=redis://your-redis-host:6379/0
REDIS_PASSWORD=your-redis-password

# 微信小程序配置
WECHAT_APP_ID=your_app_id
WECHAT_APP_SECRET=your_app_secret

# 阿里云配置
ALIYUN_ACCESS_KEY_ID=your_access_key_id
ALIYUN_ACCESS_KEY_SECRET=your_access_key_secret
ALIYUN_OSS_BUCKET=your_bucket_name

# AI分析配置（三选一）
COZE_SITE_URL=https://your-coze-site.coze.site
COZE_SITE_TOKEN=your_token
COZE_PROJECT_ID=your_project_id

# 其他配置...
```

## 常用命令

### 查看服务状态

```bash
# 查看容器状态
docker-compose -f docker-compose.prod.yml ps

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f backend

# 查看最近100行日志
docker-compose -f docker-compose.prod.yml logs --tail=100 backend
```

### 健康检查

```bash
# 检查服务健康状态
curl http://localhost:8000/health

# 或使用浏览器访问
# http://your-server-ip:8000/health
```

### 进入容器调试

```bash
# 进入后端容器
docker exec -it zhuangxiu-backend-prod bash

# 查看Python进程
docker exec -it zhuangxiu-backend-prod ps aux
```

### 清理资源

```bash
# 停止并删除容器
docker-compose -f docker-compose.prod.yml down

# 停止并删除容器和镜像
docker-compose -f docker-compose.prod.yml down --rmi local

# 清理未使用的镜像
docker image prune -a
```

## 故障排查

### 1. 服务无法启动

```bash
# 查看详细日志
docker-compose -f docker-compose.prod.yml logs backend

# 检查环境变量
docker exec zhuangxiu-backend-prod env | grep DATABASE_URL
```

### 2. 数据库连接失败

- 检查 `.env` 中的 `DATABASE_URL` 是否正确
- 确认数据库服务可访问（检查防火墙规则）
- 验证数据库用户权限

### 3. Redis连接失败

- 检查 `.env` 中的 `REDIS_URL` 和 `REDIS_PASSWORD`
- 确认Redis服务可访问
- 验证Redis密码是否正确

### 4. 端口被占用

```bash
# 查看端口占用
netstat -tulpn | grep 8000
# 或
lsof -i :8000

# 修改 docker-compose.prod.yml 中的端口映射
```

### 5. 镜像构建失败

```bash
# 清理构建缓存后重新构建
docker-compose -f docker-compose.prod.yml build --no-cache --pull backend
```

## 性能优化建议

1. **工作进程数**: 根据服务器CPU核心数调整 `--workers` 参数
   - 2核: `--workers 2`
   - 4核: `--workers 4`
   - 8核: `--workers 8`

2. **数据库连接池**: 在 `.env` 中配置
   ```env
   DATABASE_POOL_SIZE=20
   DATABASE_MAX_OVERFLOW=10
   ```

3. **日志管理**: 已配置日志轮转（最大10MB，保留3个文件）

4. **健康检查**: 已配置自动健康检查，容器异常会自动重启

## 安全建议

1. **防火墙配置**: 只开放必要端口（8000）
   ```bash
   # Ubuntu/Debian
   sudo ufw allow 8000/tcp
   
   # CentOS/RHEL
   sudo firewall-cmd --add-port=8000/tcp --permanent
   sudo firewall-cmd --reload
   ```

2. **使用HTTPS**: 建议使用Nginx反向代理并配置SSL证书

3. **环境变量安全**: 确保 `.env` 文件权限设置正确
   ```bash
   chmod 600 .env
   ```

4. **定期更新**: 定期更新Docker镜像和系统依赖

## Nginx反向代理配置（可选）

如果需要使用域名访问，可以配置Nginx反向代理：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## 监控建议

1. **日志监控**: 使用 `docker logs` 或日志收集工具（如ELK）
2. **性能监控**: 监控CPU、内存、数据库连接数等指标
3. **健康检查**: 定期检查 `/health` 接口
4. **错误告警**: 配置错误日志告警机制

## 联系支持

如遇到问题，请查看：
- API文档: `http://your-server-ip:8000/api/docs`
- 项目README: `backend/README-DOCKER.md`
- 日志文件: `docker-compose logs`
