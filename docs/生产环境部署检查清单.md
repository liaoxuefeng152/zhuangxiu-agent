# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ£€æŸ¥æ¸…å•

## ğŸ“‹ éƒ¨ç½²å‰æ£€æŸ¥

### 1. æœåŠ¡å™¨ç¯å¢ƒæ£€æŸ¥
- [ ] **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04+ æˆ– CentOS 7+
- [ ] **Docker**: `docker --version` (20.10+)
- [ ] **Docker Compose**: `docker-compose --version` (1.29+)
- [ ] **ç£ç›˜ç©ºé—´**: `df -h` (è‡³å°‘10GBå¯ç”¨ç©ºé—´)
- [ ] **å†…å­˜**: `free -h` (è‡³å°‘4GBå¯ç”¨å†…å­˜)
- [ ] **CPU**: `nproc` (è‡³å°‘2æ ¸)

### 2. ç½‘ç»œå’Œé˜²ç«å¢™æ£€æŸ¥
- [ ] **ç«¯å£å¼€æ”¾**: 80, 443ç«¯å£å·²å¼€æ”¾
  ```bash
  sudo ufw status
  # æˆ–
  sudo firewall-cmd --list-ports
  ```
- [ ] **åŸŸåè§£æ**: lakeli.top å’Œ www.lakeli.top è§£æåˆ°æœåŠ¡å™¨IP
  ```bash
  nslookup lakeli.top
  nslookup www.lakeli.top
  ```
- [ ] **SSLè¯ä¹¦**: è¯ä¹¦æ–‡ä»¶å­˜åœ¨ä¸”æœ‰æ•ˆ
  ```bash
  ls -la nginx/ssl/
  # æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ
  openssl x509 -in nginx/ssl/fullchain.pem -noout -dates
  ```

### 3. å¤–éƒ¨æœåŠ¡æ£€æŸ¥
- [ ] **æ•°æ®åº“**: PostgreSQLæœåŠ¡å¯è®¿é—®
  ```bash
  # æµ‹è¯•æ•°æ®åº“è¿æ¥
  psql "postgresql://zhuangxiu_prod_user:å¯†ç @zhangxiu-postgres-prod:5432/zhuangxiu_prod" -c "SELECT 1"
  ```
- [ ] **Redis**: RedisæœåŠ¡å¯è®¿é—®
  ```bash
  # æµ‹è¯•Redisè¿æ¥
  redis-cli -h redis-prod -p 6379 -a å¯†ç  ping
  ```
- [ ] **é˜¿é‡Œäº‘OSS**: Bucketå¯è®¿é—®
- [ ] **å¾®ä¿¡å°ç¨‹åº**: AppIDå’ŒAppSecretæ­£ç¡®

## ğŸš€ éƒ¨ç½²æ‰§è¡Œæ£€æŸ¥

### 1. é…ç½®æ–‡ä»¶æ£€æŸ¥
- [ ] **ç¯å¢ƒå˜é‡**: `.env.prod` æ–‡ä»¶å·²é…ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡
- [ ] **Nginxé…ç½®**: `nginx/conf.d/prod.conf` å·²åˆ›å»º
- [ ] **å‰ç«¯é…ç½®**: `frontend/.env.production` ä¸­APIåœ°å€æ­£ç¡®
- [ ] **Dockeré…ç½®**: `docker-compose.prod.yml` é…ç½®æ­£ç¡®

### 2. ä»£ç ä¸Šä¼ æ£€æŸ¥
- [ ] **GitçŠ¶æ€**: ä»£ç å·²æäº¤å¹¶æ¨é€åˆ°è¿œç¨‹ä»“åº“
  ```bash
  git status
  git log --oneline -5
  ```
- [ ] **æœåŠ¡å™¨ä»£ç **: æœåŠ¡å™¨ä¸Šä»£ç å·²æ›´æ–°
  ```bash
  # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
  git pull origin main
  ```

### 3. éƒ¨ç½²è„šæœ¬æ£€æŸ¥
- [ ] **è„šæœ¬æƒé™**: éƒ¨ç½²è„šæœ¬æœ‰æ‰§è¡Œæƒé™
  ```bash
  chmod +x scripts/deploy-aliyun.sh
  chmod +x scripts/restart-backend.sh
  ```
- [ ] **è„šæœ¬æµ‹è¯•**: å¯ä»¥æ­£å¸¸è¿è¡Œéƒ¨ç½²è„šæœ¬
  ```bash
  ./scripts/deploy-aliyun.sh prod --dry-run
  ```

## ğŸ”§ éƒ¨ç½²æ‰§è¡Œæ­¥éª¤

### æ­¥éª¤1: åœæ­¢ç°æœ‰æœåŠ¡
```bash
docker-compose -f docker-compose.prod.yml down
```

### æ­¥éª¤2: æ„å»ºæ–°é•œåƒ
```bash
docker-compose -f docker-compose.prod.yml build --no-cache backend
```

### æ­¥éª¤3: å¯åŠ¨æœåŠ¡
```bash
docker-compose -f docker-compose.prod.yml up -d
```

### æ­¥éª¤4: å¯åŠ¨Nginxï¼ˆå¦‚æœéœ€è¦ï¼‰
```bash
# å¦‚æœä½¿ç”¨ç‹¬ç«‹çš„Nginxå®¹å™¨
docker-compose -f docker-compose.prod.yml up -d nginx
```

### æ­¥éª¤5: éªŒè¯éƒ¨ç½²
```bash
# ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 10

# å¥åº·æ£€æŸ¥
curl -f https://lakeli.top/health

# APIæ–‡æ¡£æ£€æŸ¥
curl -f https://lakeli.top/api/docs
```

## âœ… éƒ¨ç½²åéªŒè¯

### 1. æœåŠ¡çŠ¶æ€æ£€æŸ¥
- [ ] **å®¹å™¨çŠ¶æ€**: æ‰€æœ‰å®¹å™¨è¿è¡Œæ­£å¸¸
  ```bash
  docker-compose -f docker-compose.prod.yml ps
  ```
- [ ] **æ—¥å¿—æ£€æŸ¥**: æ— é”™è¯¯æ—¥å¿—
  ```bash
  docker-compose -f docker-compose.prod.yml logs --tail=50 backend
  ```
- [ ] **ç«¯å£ç›‘å¬**: æœåŠ¡åœ¨ç›‘å¬ç«¯å£
  ```bash
  netstat -tulpn | grep 8000
  ```

### 2. åŠŸèƒ½æµ‹è¯•
- [ ] **å¥åº·æ¥å£**: `https://lakeli.top/health` è¿”å›200
- [ ] **APIæ–‡æ¡£**: `https://lakeli.top/api/docs` å¯è®¿é—®
- [ ] **ç”¨æˆ·è®¤è¯**: ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] **æ–‡ä»¶ä¸Šä¼ **: OSSä¸Šä¼ åŠŸèƒ½æ­£å¸¸
- [ ] **å¾®ä¿¡æ”¯ä»˜**: æ”¯ä»˜æµç¨‹æ­£å¸¸

### 3. æ€§èƒ½æ£€æŸ¥
- [ ] **å“åº”æ—¶é—´**: APIå“åº”æ—¶é—´ < 500ms
- [ ] **å†…å­˜ä½¿ç”¨**: å†…å­˜ä½¿ç”¨ç‡ < 80%
- [ ] **CPUä½¿ç”¨**: CPUä½¿ç”¨ç‡ < 70%
- [ ] **ç£ç›˜ç©ºé—´**: ç£ç›˜ä½¿ç”¨ç‡ < 80%

## ğŸ› æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. æœåŠ¡æ— æ³•å¯åŠ¨
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs backend

# æ£€æŸ¥ç¯å¢ƒå˜é‡
docker exec zhuangxiu-backend-prod env | grep DATABASE_URL
```

#### 2. æ•°æ®åº“è¿æ¥å¤±è´¥
- æ£€æŸ¥ `.env.prod` ä¸­çš„ `DATABASE_URL`
- ç¡®è®¤æ•°æ®åº“æœåŠ¡å¯è®¿é—®
- éªŒè¯æ•°æ®åº“ç”¨æˆ·æƒé™

#### 3. Nginxé…ç½®é”™è¯¯
```bash
# æ£€æŸ¥Nginxé…ç½®
nginx -t -c /etc/nginx/nginx.conf

# æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/error.log
```

#### 4. SSLè¯ä¹¦é—®é¢˜
```bash
# æ£€æŸ¥è¯ä¹¦è·¯å¾„
ls -la /etc/nginx/ssl/

# æ£€æŸ¥è¯ä¹¦æƒé™
chmod 600 /etc/nginx/ssl/*.pem
```

#### 5. ç«¯å£è¢«å ç”¨
```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
lsof -i :80
lsof -i :443
lsof -i :8000
```

## ğŸ“Š ç›‘æ§é…ç½®

### 1. æ—¥å¿—ç›‘æ§
- [ ] **åº”ç”¨æ—¥å¿—**: é…ç½®æ—¥å¿—è½®è½¬
- [ ] **è®¿é—®æ—¥å¿—**: Nginxè®¿é—®æ—¥å¿—
- [ ] **é”™è¯¯æ—¥å¿—**: é”™è¯¯æ—¥å¿—å‘Šè­¦

### 2. æ€§èƒ½ç›‘æ§
- [ ] **CPUç›‘æ§**: è®¾ç½®CPUä½¿ç”¨ç‡å‘Šè­¦
- [ ] **å†…å­˜ç›‘æ§**: è®¾ç½®å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦
- [ ] **ç£ç›˜ç›‘æ§**: è®¾ç½®ç£ç›˜ä½¿ç”¨ç‡å‘Šè­¦

### 3. ä¸šåŠ¡ç›‘æ§
- [ ] **å¥åº·æ£€æŸ¥**: å®šæœŸæ£€æŸ¥ `/health` æ¥å£
- [ ] **é”™è¯¯ç‡ç›‘æ§**: APIé”™è¯¯ç‡ç›‘æ§
- [ ] **å“åº”æ—¶é—´ç›‘æ§**: APIå“åº”æ—¶é—´ç›‘æ§

## ğŸ”’ å®‰å…¨é…ç½®

### 1. é˜²ç«å¢™é…ç½®
```bash
# åªå¼€æ”¾å¿…è¦ç«¯å£
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable
```

### 2. æ–‡ä»¶æƒé™
```bash
# ä¿æŠ¤ç¯å¢ƒå˜é‡æ–‡ä»¶
chmod 600 .env.prod

# ä¿æŠ¤SSLè¯ä¹¦
chmod 600 nginx/ssl/*.pem
```

### 3. å®šæœŸæ›´æ–°
- [ ] **ç³»ç»Ÿæ›´æ–°**: å®šæœŸæ›´æ–°æ“ä½œç³»ç»Ÿ
- [ ] **Dockeræ›´æ–°**: å®šæœŸæ›´æ–°Dockerå’Œé•œåƒ
- [ ] **è¯ä¹¦æ›´æ–°**: SSLè¯ä¹¦åˆ°æœŸå‰æ›´æ–°

## ğŸ“ ç´§æ€¥è”ç³»äºº

- **è¿ç»´è´Ÿè´£äºº**: [å§“å]
- **å¼€å‘è´Ÿè´£äºº**: [å§“å]
- **è”ç³»ç”µè¯**: [ç”µè¯]
- **å¤‡ç”¨è”ç³»äºº**: [å§“å]

---

**æœ€åæ£€æŸ¥æ—¶é—´**: ______________  
**æ£€æŸ¥äºº**: ______________  
**éƒ¨ç½²çŠ¶æ€**: â–¡ æˆåŠŸ â–¡ å¤±è´¥ â–¡ éƒ¨åˆ†æˆåŠŸ  

**å¤‡æ³¨**:  
________________________________________________________________  
________________________________________________________________  
________________________________________________________________
