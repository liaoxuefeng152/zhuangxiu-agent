# 双环境部署流程规范

## 📋 概述

本项目采用**双环境部署策略**，确保代码质量并降低生产环境风险：

```
本地开发 → Git开发分支 → 阿里云开发环境 → Git主分支 → 阿里云生产环境
```

## 🚀 完整部署流程（10步）

### **阶段1：开发环境部署（测试验证）**

#### 步骤1：本地开发分支提交
```bash
# 确保在dev分支
git checkout dev

# 提交代码到本地dev仓库
git add .
git commit -m "feat: 描述本次修改"

# 示例：git commit -m "feat: 迁移OCR服务从通用文字识别到OCR统一识别API"
```

#### 步骤2：推送到远程开发仓库
```bash
git push origin dev
```

#### 步骤3：部署到阿里云开发环境
```bash
# SSH连接到开发服务器
ssh -i ~/zhuangxiu-agent1.pem root@120.26.201.61

# 进入开发环境项目目录
cd /root/project/dev/zhuangxiu-agent

# 拉取开发分支最新代码
git checkout dev
git pull origin dev

# 重新构建并重启开发环境后端
docker compose -f docker-compose.dev.yml build backend --no-cache
docker compose -f docker-compose.dev.yml up -d backend
```

#### 步骤4：测试开发环境功能
- 测试新功能是否正常工作
- 验证API接口返回正确结果
- 检查日志确认无错误
- 进行集成测试

### **阶段2：生产环境部署（正式上线）**

#### 步骤5：合并到本地主分支
```bash
# 切换回本地main分支
git checkout main

# 拉取最新main分支代码
git pull origin main

# 合并dev分支到main分支
git merge dev

# 解决可能的冲突（如果有）
# git mergetool  # 使用合并工具解决冲突
# git add .      # 添加解决后的文件
# git commit -m "merge: 合并dev分支到main"
```

#### 步骤6：推送到远程主仓库
```bash
git push origin main
```

#### 步骤7：部署到阿里云生产环境
```bash
# SSH连接到生产服务器
# 注意：生产服务器可能需要不同的SSH密钥或IP地址
# 假设生产服务器也是120.26.201.61，但使用不同目录

# 进入生产环境项目目录
cd /root/project/prod/zhuangxiu-agent

# 拉取主分支最新代码
git checkout main
git pull origin main

# 重新构建并重启生产环境后端
docker compose -f docker-compose.prod.yml build backend --no-cache
docker compose -f docker-compose.prod.yml up -d backend
```

#### 步骤8：测试生产环境功能
```bash
# 健康检查
curl -f https://lakeli.top/health

# 功能测试
# 通过前端界面测试新功能
# 验证生产环境API接口
```

### **阶段3：部署后验证**

#### 步骤9：监控和日志检查
```bash
# 检查生产环境日志
docker compose -f docker-compose.prod.yml logs --tail=100 backend

# 检查错误日志
docker compose -f docker-compose.prod.yml logs backend | grep -i error

# 监控服务状态
docker compose -f docker-compose.prod.yml ps
```

#### 步骤10：回滚计划（如有需要）
```bash
# 如果需要回滚，使用Git回退
git revert <commit-hash>
# 或
git reset --hard <previous-commit>

# 然后重新部署
git push origin main --force  # 谨慎使用--force
# 重新执行步骤7-9
```

## 📁 项目目录结构

```
阿里云服务器：
├── /root/project/dev/zhuangxiu-agent/    # 开发环境
│   ├── docker-compose.dev.yml            # 开发环境配置
│   ├── .env.dev                          # 开发环境变量
│   ├── backend/                          # 后端代码
│   └── ...
├── /root/project/prod/zhuangxiu-agent/   # 生产环境
│   ├── docker-compose.prod.yml           # 生产环境配置
│   ├── .env.prod                         # 生产环境变量
│   ├── nginx/                            # Nginx配置
│   └── ...
```

## 🔧 环境配置差异

| 配置项 | 开发环境 | 生产环境 |
|--------|----------|----------|
| **端口** | 8001 | 8000 |
| **域名** | dev.lakeli.top (可选) | lakeli.top |
| **数据库** | zhuangxiu_dev | zhuangxiu_prod |
| **Redis** | redis-dev | redis-prod |
| **日志级别** | DEBUG | INFO |
| **工作进程** | 1个 | 4个 |
| **调试模式** | 开启 | 关闭 |
| **AI分析渠道** | 测试渠道 | 生产渠道 |
| **微信配置** | 测试AppID | 生产AppID |

## ⚠️ 重要规则

### 1. 禁止跳过测试
- **必须**先在开发环境测试，确认无误后再部署到生产环境
- **禁止**未经测试直接部署到生产环境

### 2. 禁止直接修改服务器代码
- 所有修改**必须**通过Git流程
- **禁止**直接在服务器上修改代码文件

### 3. 强制代码审查（建议）
- 建议在合并到main分支前进行代码审查
- 使用Pull Request流程进行代码审查

### 4. 备份策略
- 生产环境部署前**必须**备份数据库
- 重要配置文件**必须**有备份

### 5. 监控告警
- 生产环境部署后**必须**密切监控系统状态
- 设置关键指标告警（CPU、内存、错误率等）

## 📝 部署检查清单

### 开发环境部署前检查
- [ ] 代码已通过本地测试
- [ ] 代码已提交到dev分支
- [ ] 代码已推送到远程dev仓库
- [ ] 开发环境配置文件已更新（如有需要）

### 生产环境部署前检查
- [ ] 开发环境测试通过
- [ ] 代码已合并到main分支
- [ ] 代码已推送到远程main仓库
- [ ] 生产环境配置文件已更新
- [ ] 数据库迁移已执行（如有）
- [ ] 监控系统已就绪
- [ ] 回滚方案已准备

### 部署后验证
- [ ] 健康检查通过
- [ ] 功能测试通过
- [ ] 日志无错误
- [ ] 性能指标正常

## 🐛 故障排查指南

### 1. 部署失败
```bash
# 查看详细错误信息
docker compose -f docker-compose.prod.yml logs backend

# 检查环境变量
docker exec zhuangxiu-backend-prod env | grep DATABASE_URL

# 检查端口占用
lsof -i :8000
```

### 2. 服务无法启动
```bash
# 检查容器状态
docker compose -f docker-compose.prod.yml ps

# 检查容器日志
docker logs zhuangxiu-backend-prod

# 进入容器调试
docker exec -it zhuangxiu-backend-prod bash
```

### 3. 数据库连接失败
- 检查 `.env.prod` 中的 `DATABASE_URL`
- 确认数据库服务可访问
- 验证数据库用户权限

### 4. Git合并冲突
```bash
# 查看冲突文件
git status

# 使用合并工具解决冲突
git mergetool

# 完成合并
git add .
git commit -m "merge: 解决合并冲突"
```

## 📞 紧急联系人

- **运维负责人**: [姓名]
- **开发负责人**: [姓名]
- **联系电话**: [电话]
- **备用联系人**: [姓名]

## 📊 部署记录模板

```
部署时间: ______________
部署版本: ______________
部署人: ______________
部署环境: □ 开发环境 □ 生产环境
部署状态: □ 成功 □ 失败 □ 部分成功

变更内容:
________________________________________________________________
________________________________________________________________
________________________________________________________________

测试结果:
________________________________________________________________
________________________________________________________________
________________________________________________________________

问题记录:
________________________________________________________________
________________________________________________________________
________________________________________________________________

备注:
________________________________________________________________
________________________________________________________________
________________________________________________________________
```

## 🎯 最佳实践

1. **小步快跑**：每次部署的变更尽量小，便于排查问题
2. **自动化测试**：建立自动化测试流程，减少人工测试工作量
3. **蓝绿部署**：考虑使用蓝绿部署策略，实现零停机部署
4. **监控告警**：建立完善的监控告警体系，及时发现和处理问题
5. **文档更新**：每次部署后及时更新相关文档

---

**最后更新**: 2026年2月22日  
**版本**: 1.0.0  
**制定人**: 装修决策Agent团队  
**审核人**: ______________  
**批准人**: ______________
