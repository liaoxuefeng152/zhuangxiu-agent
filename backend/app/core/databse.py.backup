"""
装修决策Agent - 数据库配置
"""
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession, async_sessionmaker
from sqlalchemy.orm import declarative_base
from sqlalchemy.pool import QueuePool
from app.core.config import settings
import logging

logger = logging.getLogger(__name__)

# 创建异步引擎（优化连接池配置）
engine = create_async_engine(
    settings.DATABASE_URL,
    poolclass=QueuePool,
    pool_size=settings.DATABASE_POOL_SIZE,
    max_overflow=settings.DATABASE_MAX_OVERFLOW,
    pool_timeout=settings.DATABASE_POOL_TIMEOUT,
    pool_recycle=settings.DATABASE_POOL_RECYCLE,
    pool_pre_ping=True,  # 启用连接健康检查
    echo=settings.DEBUG,
    future=True,
    connect_args={
        "server_settings": {
            "application_name": settings.APP_NAME,
            
        }
    },
    module=__import__("asyncpg"),
)

# 创建异步会话工厂
AsyncSessionLocal = async_sessionmaker(
    engine,
    class_=AsyncSession,
    expire_on_commit=False,
    autocommit=False,
    autoflush=False
)

# 声明基类
Base = declarative_base()


async def get_pool_status() -> dict:
    """
    获取连接池状态

    Returns:
        连接池状态信息字典
    """
    pool = engine.pool
    return {
        "size": pool.size(),
        "checked_in": pool.checkedin(),
        "checked_out": pool.checkedout(),
        "overflow": pool.overflow(),
        "invalidated": pool.invalidated(),
    }


async def init_db():
    """初始化数据库"""
    try:
        async with engine.begin() as conn:
            # 导入所有模型以确保它们被注册
            from app.models import User, Quote, Contract, CompanyScan, Order, Construction

            # 创建所有表（开发环境）
            if settings.DEBUG:
                await conn.run_sync(Base.metadata.create_all)
                logger.info("数据库表创建完成")
            else:
                logger.info("生产环境，跳过自动创建表")
    except Exception as e:
        logger.error(f"数据库初始化失败: {e}", exc_info=True)
        raise


async def get_db() -> AsyncSession:
    """
    获取数据库会话（带事务管理）

    Yields:
        AsyncSession: 数据库会话
    """
    async with AsyncSessionLocal() as session:
        try:
            yield session
            await session.commit()  # 提交事务
        except Exception as e:
            logger.error(f"数据库会话异常: {e}", exc_info=True)
            await session.rollback()  # 回滚事务
            raise
        finally:
            await session.close()


async def close_db():
    """关闭数据库连接"""
    await engine.dispose()
    logger.info("数据库连接已关闭")
