# 登录功能检查报告

## 一、登录触发情况总结

### 1.1 手动登录触发

#### 场景1：用户点击"立即登录"按钮
**位置**：`frontend/src/pages/profile/index.tsx`
- **触发条件**：用户在"我的"页面未登录时，点击"立即登录"按钮
- **代码位置**：`handleLogin()` 函数（第76-130行）
- **流程**：
  1. 显示"登录中..."加载提示
  2. 根据环境获取登录code：
     - **H5环境**：使用模拟code `dev_h5_mock`
     - **小程序环境**：调用 `Taro.login()` 获取微信code
  3. 调用后端登录API：`POST /api/v1/users/login`
  4. 保存token和用户信息到本地存储
  5. 更新Redux状态
  6. 显示"登录成功"提示

---

#### 场景2：用户主动退出后重新登录
**位置**：`frontend/src/pages/profile/index.tsx`
- **触发条件**：用户点击"退出登录"后，再次点击"立即登录"
- **流程**：同场景1

---

### 1.2 自动登录触发

#### 场景3：小程序启动时自动静默登录（开发/体验版）
**位置**：`frontend/src/app.tsx`
- **触发条件**：
  - 小程序启动时
  - 本地没有 `access_token`
  - 开发/体验版环境
- **代码位置**：`useDevSilentLogin()` Hook（第12-34行）
- **流程**：
  1. 检查是否有token，如果没有则自动登录
  2. 使用 `dev_weapp_mock` code进行模拟登录
  3. 静默完成，不显示加载提示
  4. 保存token到本地存储
- **目的**：方便在微信开发者工具中测试，无需手动登录

```typescript
// app.tsx 第12-34行
function useDevSilentLogin() {
  useEffect(() => {
    const token = Taro.getStorageSync('access_token')
    if (!token) {
      Taro.request({
        url: `${env.apiBaseUrl}/users/login`,
        method: 'POST',
        header: { 'Content-Type': 'application/json' },
        data: { code: 'dev_weapp_mock' }
      }).then((res) => {
        const d = (res.data as any)?.data ?? res.data
        if (d?.access_token) {
          Taro.setStorageSync('access_token', d.access_token)
          Taro.setStorageSync('user_id', d.user_id)
        }
      }).catch(() => {})
    }
  }, [])
}
```

---

### 1.3 Token过期触发重新登录

#### 场景4：API请求返回401时自动跳转登录
**位置**：`frontend/src/services/api.ts`
- **触发条件**：
  - API请求返回401状态码（未授权）
  - Token过期或无效
- **代码位置**：响应拦截器（第79-86行）
- **流程**：
  1. 检测到401错误
  2. 清除本地token和user_id
  3. 跳转到引导页（`/pages/onboarding/index`）
  4. 用户需要重新登录

```typescript
// api.ts 第79-86行
case 401:
  message = '登录已过期，请重新登录'
  // 清除token并跳转登录页
  Taro.removeStorageSync('access_token')
  Taro.removeStorageSync('user_id')
  Taro.reLaunch({ url: '/pages/onboarding/index' })
  break
```

---

### 1.4 首次使用触发登录

#### 场景5：新用户首次打开小程序
**位置**：`frontend/src/pages/onboarding/index.tsx`
- **触发条件**：
  - 用户首次打开小程序
  - 本地没有 `onboarding_completed` 标记
- **流程**：
  1. 显示引导页（P01）
  2. 用户点击"开始使用"或倒计时结束
  3. 跳转到首页（P02）
  4. **注意**：引导页本身不触发登录，登录在后续页面触发

---

## 二、后端登录API逻辑

### 2.1 登录API端点

**路径**：`POST /api/v1/users/login`
**文件**：`backend/app/api/v1/users.py`（第42-165行）

### 2.2 登录流程

#### 情况1：开发环境模拟登录
**条件**：
- `code` 为 `dev_h5_mock` 或 `dev_weapp_mock`
- `DEBUG=True`（环境变量）

**流程**：
1. 查找或创建开发用户（openid: `dev_h5_openid`）
2. 生成JWT Token（7天有效期）
3. 返回用户信息和token

**代码位置**：第60-95行

---

#### 情况2：正式环境微信登录
**条件**：
- `code` 为微信小程序返回的真实code
- 或开发环境模拟登录条件不满足

**流程**：
1. 调用微信API：`https://api.weixin.qq.com/sns/jscode2session`
   - 参数：`appid`, `secret`, `js_code`, `grant_type`
2. 获取openid和unionid
3. 查找或创建用户：
   - **新用户**：创建用户记录，默认昵称 `用户{openid后6位}`
   - **老用户**：更新unionid（如果存在）
4. 生成JWT Token（7天有效期）
5. 返回用户信息和token

**代码位置**：第97-156行

---

### 2.3 错误处理

| 错误情况 | HTTP状态码 | 错误信息 |
|---------|-----------|---------|
| 微信API返回错误 | 401 | `微信登录失败: {errmsg}` |
| SECRET_KEY未配置 | 500 | `SECRET_KEY 未配置，无法生成 Token` |
| 其他异常 | 500 | `登录服务暂时不可用` |

---

## 三、登录状态管理

### 3.1 本地存储

**存储的键值**：
- `access_token`：JWT Token
- `user_id`：用户ID
- `onboarding_completed`：引导页完成标记
- `has_onboarded`：是否已完成引导

**存储位置**：微信小程序本地存储（`Taro.setStorageSync`）

---

### 3.2 Redux状态管理

**文件**：`frontend/src/store/slices/userSlice.ts`

**状态结构**：
```typescript
{
  userInfo: {
    userId: number,
    openid: string,
    nickname: string,
    avatarUrl: string,
    phone: string,
    phoneVerified: boolean,
    isMember: boolean
  },
  isLoggedIn: boolean
}
```

**Actions**：
- `setUserInfo`：设置用户信息并标记已登录
- `logout`：清除用户信息并标记未登录
- `updateUserInfo`：更新部分用户信息

---

## 四、登录触发条件汇总表

| 触发场景 | 触发位置 | 触发条件 | 登录方式 | 是否需要用户操作 |
|---------|---------|---------|---------|----------------|
| 手动登录 | 我的页面 | 点击"立即登录" | 微信code或模拟code | ✅ 是 |
| 自动登录 | 小程序启动 | 无token + 开发/体验版 | 模拟code (`dev_weapp_mock`) | ❌ 否 |
| Token过期 | API请求 | 401错误 | 跳转引导页，需重新登录 | ✅ 是 |
| 首次使用 | 引导页 | 首次打开小程序 | 不自动登录，后续手动触发 | ✅ 是 |

---

## 五、登录流程时序图

```
用户打开小程序
    ↓
检查是否有token
    ↓
    ├─ 有token → 直接使用（检查是否过期）
    │              ↓
    │           过期 → 清除token → 跳转引导页
    │
    └─ 无token → 检查环境
                  ↓
              ├─ 开发/体验版 → 自动静默登录（dev_weapp_mock）
              │
              └─ 正式版 → 显示引导页
                           ↓
                       用户点击"开始使用"
                           ↓
                       跳转首页
                           ↓
                       用户点击"立即登录"（我的页面）
                           ↓
                       调用Taro.login()获取code
                           ↓
                       调用后端登录API
                           ↓
                       保存token和用户信息
                           ↓
                       登录完成
```

---

## 六、潜在问题分析

### 6.1 问题1：自动登录可能失败但不提示

**位置**：`app.tsx` 的 `useDevSilentLogin()`
**问题**：自动登录失败时，`.catch(() => {})` 吞掉了错误，用户不知道登录失败
**建议**：添加错误日志或提示

---

### 6.2 问题2：Token过期后跳转引导页可能不合适

**位置**：`api.ts` 响应拦截器
**问题**：Token过期后跳转到引导页，但用户可能已经完成引导
**建议**：跳转到登录页面或首页，让用户重新登录

---

### 6.3 问题3：H5环境使用模拟登录

**位置**：`profile/index.tsx` 的 `handleLogin()`
**问题**：H5环境使用 `dev_h5_mock`，需要后端 `DEBUG=True`
**建议**：确保开发环境正确配置

---

### 6.4 问题4：首次使用不自动登录

**位置**：引导页逻辑
**问题**：首次使用需要用户手动点击"立即登录"
**建议**：考虑在引导页完成后自动尝试登录（如果用户授权）

---

## 七、登录检查清单

### 7.1 开发环境检查

- [ ] `.env` 中 `DEBUG=True`
- [ ] `.env` 中 `SECRET_KEY` 已配置
- [ ] `.env` 中 `WECHAT_APP_ID` 和 `WECHAT_APP_SECRET` 已配置（正式环境）
- [ ] 后端服务正常运行

### 7.2 前端检查

- [ ] 引导页正常显示
- [ ] "我的"页面显示登录按钮（未登录时）
- [ ] 点击登录按钮能正常登录
- [ ] Token正确保存到本地存储
- [ ] 登录后用户信息正确显示
- [ ] Token过期后能正确处理

### 7.3 功能检查

- [ ] 开发环境自动登录功能正常
- [ ] 手动登录功能正常
- [ ] Token过期后重新登录流程正常
- [ ] 退出登录功能正常
- [ ] 登录状态正确同步到Redux

---

## 八、已修复的问题

### 8.1 ✅ 改进自动登录错误处理

**位置**：`frontend/src/app.tsx` 的 `useDevSilentLogin()`

**修复内容**：
- 添加了详细的错误日志（`console.log` 和 `console.error`）
- 成功时记录日志：`[自动登录] 开发环境自动登录成功`
- 失败时记录错误：`[自动登录] 开发环境自动登录失败`
- 响应格式异常时记录警告：`[自动登录] 登录响应格式异常`
- 开发环境提示：如果后端服务未启动，会在控制台提示

**代码变更**：
```typescript
.then((res) => {
  // ... 登录逻辑
  console.log('[自动登录] 开发环境自动登录成功')
}).catch((err) => {
  console.error('[自动登录] 开发环境自动登录失败:', err)
  if (process.env.NODE_ENV === 'development') {
    console.warn('[自动登录] 提示：请确保后端服务已启动，或手动在"我的"页面登录')
  }
})
```

---

### 8.2 ✅ 改进Token过期处理

**位置**：`frontend/src/services/api.ts` 响应拦截器

**修复内容**：
- Token过期后不再跳转到引导页
- 检查用户是否已完成引导（`onboarding_completed`）
- 如果已完成引导：
  - 跳转到首页（`/pages/index/index`）
  - 延迟显示提示弹窗："登录已过期，请前往'我的'页面重新登录"
- 如果未完成引导：
  - 跳转到引导页（保持原有逻辑）

**代码变更**：
```typescript
case 401:
  message = '登录已过期，请重新登录'
  Taro.removeStorageSync('access_token')
  Taro.removeStorageSync('user_id')
  
  const hasOnboarded = Taro.getStorageSync('onboarding_completed') || Taro.getStorageSync('has_onboarded')
  if (hasOnboarded) {
    Taro.reLaunch({ url: '/pages/index/index' })
    setTimeout(() => {
      Taro.showModal({
        title: '登录已过期',
        content: '您的登录已过期，请前往"我的"页面重新登录',
        showCancel: false,
        confirmText: '知道了'
      })
    }, 500)
  } else {
    Taro.reLaunch({ url: '/pages/onboarding/index' })
  }
  break
```

---

### 8.3 ✅ 添加登录状态检查工具函数

**位置**：`frontend/src/utils/auth.ts`（新建文件）

**功能**：
- `isLoggedIn()`: 检查用户是否已登录
- `getToken()`: 获取当前用户的Token
- `getUserId()`: 获取当前用户的ID
- `checkLogin()`: 检查登录状态，如果未登录则提示并跳转
- `clearLogin()`: 清除登录信息
- `saveLogin()`: 保存登录信息
- `isTokenExpired()`: 检查Token是否过期

**使用示例**：
```typescript
import { checkLogin } from '../../utils/auth'

const handleUpload = async () => {
  // 检查登录状态
  if (!checkLogin()) {
    return // 未登录，已显示提示并跳转
  }
  
  // 继续上传逻辑
  // ...
}
```

---

### 8.4 ✅ 在关键页面添加登录检查

**已添加登录检查的页面**：
1. **报价单上传页面** (`frontend/src/pages/quote-upload/index.tsx`)
   - 在上传前检查登录状态
   - 未登录时提示并跳转到"我的"页面

2. **合同上传页面** (`frontend/src/pages/contract-upload/index.tsx`)
   - 在上传前检查登录状态
   - 未登录时提示并跳转到"我的"页面

**代码示例**：
```typescript
const handleUpload = async () => {
  if (!file) {
    Taro.showToast({ title: '请先选择或拍摄文件', icon: 'none' })
    return
  }
  
  // 检查登录状态
  if (!checkLogin()) {
    return
  }
  
  // 继续上传逻辑
  // ...
}
```

---

## 九、建议改进（待实现）

### 9.1 添加登录重试机制

如果自动登录失败，可以：
1. 记录失败次数
2. 达到一定次数后停止自动登录
3. 提示用户手动登录

### 9.2 添加Token刷新机制

当前Token有效期7天，可以考虑：
1. 在Token即将过期时自动刷新
2. 使用refresh token机制
3. 减少用户需要重新登录的频率

### 9.3 优化登录体验

1. 登录成功后自动刷新相关页面数据
2. 登录失败时提供更详细的错误信息
3. 支持记住登录状态（可选）

---

## 九、总结

### 9.1 登录触发情况

1. **手动触发**：用户在"我的"页面点击"立即登录"
2. **自动触发**：小程序启动时（开发/体验版，无token时）
3. **过期触发**：API返回401时，清除token并跳转引导页
4. **首次使用**：不自动登录，需要用户手动触发

### 9.2 登录方式

- **开发环境**：使用模拟code（`dev_h5_mock` 或 `dev_weapp_mock`）
- **正式环境**：使用微信小程序 `Taro.login()` 获取的真实code

### 9.3 登录状态管理

- **本地存储**：`access_token` 和 `user_id`
- **Redux状态**：`userInfo` 和 `isLoggedIn`
- **Token有效期**：7天

---

**报告生成时间**：2026-02-10  
**检查范围**：前端登录逻辑、后端登录API、自动登录机制、Token管理
