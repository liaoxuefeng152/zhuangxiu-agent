# 系统启动说明

## 一、后端服务启动

### 1.1 检查服务状态

后端服务默认运行在 `http://localhost:8000`

**检查服务是否运行：**
```bash
curl http://localhost:8000/health
```

**检查端口占用：**
```bash
lsof -ti:8000
```

### 1.2 启动后端服务

**方式1：直接运行（开发模式）**
```bash
cd backend
python main.py
```

**方式2：使用uvicorn（推荐）**
```bash
cd backend
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

**方式3：后台运行**
```bash
cd backend
nohup uvicorn main:app --host 0.0.0.0 --port 8000 --reload > backend.log 2>&1 &
```

### 1.3 验证服务启动

访问以下URL验证服务是否正常：
- **健康检查**：http://localhost:8000/health
- **API文档**：http://localhost:8000/api/docs
- **ReDoc文档**：http://localhost:8000/api/redoc

### 1.4 环境配置

确保 `.env` 文件配置正确：
```bash
# 数据库配置
DATABASE_URL=postgresql://user:password@localhost:5432/zhuangxiu_prod

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379

# 调试模式
DEBUG=True

# 阿里云OCR配置（可选）
ALIYUN_ACCESS_KEY_ID=your_key_id
ALIYUN_ACCESS_KEY_SECRET=your_key_secret
ALIYUN_OCR_ENDPOINT=ocr-api.cn-hangzhou.aliyuncs.com

# 天眼查API配置（可选）
TIANYANCHA_API_KEY=your_api_key

# AI服务配置
DEEPSEEK_API_KEY=your_api_key
COZE_API_KEY=your_api_key
COZE_BOT_ID=your_bot_id
```

---

## 二、微信小程序开发工具配置

### 2.1 打开项目

1. 打开微信开发者工具
2. 选择"导入项目"
3. 项目目录选择：`/Users/mac/zhuangxiu-agent-backup/frontend`
4. AppID：使用测试号或正式AppID

### 2.2 API配置

**开发环境配置：**

前端配置文件：`frontend/config/index.js`

开发环境API地址：
```javascript
process.env.TARO_APP_API_BASE_URL: 'http://localhost:8000/api/v1'
```

**注意**：微信小程序无法直接访问 `localhost`，需要配置：

#### 方案1：使用本机IP地址（推荐）

1. 获取本机IP地址：
```bash
# macOS
ifconfig | grep "inet " | grep -v 127.0.0.1

# 或
ipconfig getifaddr en0
```

2. 修改 `frontend/config/dev.js`：
```javascript
module.exports = {
  env: {
    TARO_APP_API_BASE_URL: 'http://192.168.x.x:8000/api/v1'  // 替换为你的本机IP
  }
}
```

3. 在微信开发者工具中：
   - 点击右上角"详情"
   - 勾选"不校验合法域名、web-view（业务域名）、TLS版本以及HTTPS证书"

#### 方案2：使用ngrok等内网穿透工具

```bash
# 安装ngrok
brew install ngrok

# 启动内网穿透
ngrok http 8000
```

使用ngrok提供的HTTPS地址（如：`https://xxxx.ngrok.io/api/v1`）

### 2.3 编译运行

```bash
cd frontend
npm install  # 首次运行需要安装依赖
npm run dev:weapp  # 编译微信小程序
```

编译完成后，在微信开发者工具中点击"编译"按钮即可。

---

## 三、验证步骤

### 3.1 后端服务验证

1. **健康检查**
```bash
curl http://localhost:8000/health
```

预期返回：
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "status": "healthy",
    "version": "2.2.0"
  }
}
```

2. **用户登录测试**
```bash
curl -X POST http://localhost:8000/api/v1/users/login \
  -H "Content-Type: application/json" \
  -d '{"code": "dev_h5_mock"}'
```

### 3.2 前端功能验证

在微信开发者工具中验证以下功能：

1. **用户登录**
   - 打开小程序
   - 点击登录（开发环境使用模拟登录）

2. **公司风险检测**
   - 输入公司名称
   - 提交检测
   - 查看检测结果

3. **报价单分析**
   - 上传报价单图片
   - 等待OCR识别和AI分析
   - 查看分析结果

4. **合同审核**
   - 上传合同图片
   - 等待OCR识别和AI审核
   - 查看审核结果

5. **施工进度管理**
   - 设置开工日期
   - 查看6大阶段进度
   - 完成阶段验收

---

## 四、常见问题

### 4.1 后端服务无法启动

**问题**：端口被占用
```bash
# 查看占用进程
lsof -ti:8000

# 杀死进程
kill -9 <PID>
```

**问题**：数据库连接失败
- 检查PostgreSQL是否运行
- 检查 `.env` 中的 `DATABASE_URL` 配置
- 检查数据库是否已创建

**问题**：Redis连接失败
- 检查Redis是否运行：`redis-cli ping`
- 检查 `.env` 中的Redis配置

### 4.2 前端无法连接后端

**问题**：网络请求失败
- 确保后端服务正在运行
- 检查API地址配置是否正确
- 在微信开发者工具中勾选"不校验合法域名"

**问题**：CORS错误
- 检查后端CORS配置
- 确保 `ALLOWED_ORIGINS` 包含小程序域名

### 4.3 功能异常

**问题**：OCR识别失败
- 检查阿里云OCR配置
- 如果未配置，系统会使用Mock数据（DEBUG模式下）

**问题**：AI分析失败
- 检查AI服务配置（DeepSeek/Coze）
- 查看后端日志获取详细错误信息

---

## 五、开发调试

### 5.1 后端日志

**查看实时日志：**
```bash
# 如果使用nohup启动
tail -f backend.log

# 或直接查看控制台输出
```

**日志级别：**
- INFO：一般信息
- WARNING：警告信息
- ERROR：错误信息

### 5.2 前端调试

**微信开发者工具调试：**
1. 打开"调试器"面板
2. 查看Console日志
3. 查看Network请求
4. 使用断点调试

**API请求调试：**
- 在Network面板查看请求和响应
- 检查请求头、请求体、响应状态码

---

## 六、测试账号

### 6.1 开发环境登录

**模拟登录（开发环境）：**
```json
{
  "code": "dev_h5_mock"
}
```

**模拟登录（小程序）：**
```json
{
  "code": "dev_weapp_mock"
}
```

### 6.2 测试数据

测试文件位置：
- 报价单：`2026年深圳住宅装修真实报价单（89㎡三室一厅，半包，中档品质）.png`
- 合同：`深圳市住宅装饰装修工程施工合同（半包装修版）.png`

---

## 七、快速启动命令

### 7.1 一键启动脚本

创建 `start.sh`：
```bash
#!/bin/bash

# 启动后端服务
cd backend
nohup uvicorn main:app --host 0.0.0.0 --port 8000 --reload > ../backend.log 2>&1 &
echo "后端服务已启动，日志：backend.log"

# 等待服务启动
sleep 3

# 检查服务状态
curl -s http://localhost:8000/health && echo "✅ 后端服务正常" || echo "❌ 后端服务异常"

echo ""
echo "前端启动："
echo "  cd frontend"
echo "  npm run dev:weapp"
```

**使用：**
```bash
chmod +x start.sh
./start.sh
```

### 7.2 停止服务

```bash
# 停止后端服务
lsof -ti:8000 | xargs kill -9

# 或使用
pkill -f "uvicorn main:app"
```

---

## 八、当前服务状态

**后端服务：**
- 状态：✅ 运行中（端口8000）
- 健康检查：http://localhost:8000/health
- API文档：http://localhost:8000/api/docs

**前端配置：**
- API地址：`http://localhost:8000/api/v1`（开发环境）
- 需要配置本机IP或使用内网穿透工具

**下一步：**
1. 获取本机IP地址
2. 修改 `frontend/config/dev.js` 中的API地址
3. 在微信开发者工具中打开项目
4. 开始验证功能
