# 微信开发工具验证指南

## ✅ 当前状态

**后端服务：** ✅ 已启动并运行正常
- 地址：http://localhost:8000
- 健康检查：✅ 正常
- API文档：http://localhost:8000/api/docs

---

## 📱 在微信开发工具中验证

### 第一步：获取本机IP地址

由于微信小程序无法直接访问 `localhost`，需要配置本机IP地址。

**方法1：在终端中获取**
```bash
# macOS
ifconfig | grep "inet " | grep -v 127.0.0.1

# 或
ipconfig getifaddr en0
```

**方法2：在系统设置中查看**
- 打开"系统设置" → "网络"
- 查看当前连接的网络
- 记录IP地址（通常是 192.168.x.x 或 10.x.x.x）

**方法3：使用内网穿透工具（推荐）**
```bash
# 安装ngrok
brew install ngrok

# 启动内网穿透（会生成一个HTTPS地址）
ngrok http 8000
```

---

### 第二步：配置前端API地址

**选项A：使用本机IP（推荐）**

编辑 `frontend/config/dev.js`：
```javascript
module.exports = {
  env: {
    TARO_APP_MODE: 'dev',
    TARO_APP_API_BASE_URL: 'http://192.168.x.x:8000/api/v1'  // 替换为你的本机IP
  }
}
```

**选项B：使用ngrok（如果使用内网穿透）**

编辑 `frontend/config/dev.js`：
```javascript
module.exports = {
  env: {
    TARO_APP_MODE: 'dev',
    TARO_APP_API_BASE_URL: 'https://xxxx.ngrok.io/api/v1'  // 替换为ngrok提供的地址
  }
}
```

---

### 第三步：打开微信开发工具

1. **打开微信开发者工具**
2. **导入项目**
   - 项目目录：`/Users/mac/zhuangxiu-agent-backup/frontend`
   - AppID：`wx8a976249ea20a859`（已在project.config.json中配置）
   - 项目名称：装修避坑管家

3. **配置开发设置**
   - 点击右上角"详情"
   - 在"本地设置"中：
     - ✅ **勾选"不校验合法域名、web-view（业务域名）、TLS版本以及HTTPS证书"**
     - ✅ 勾选"不校验安全域名"

---

### 第四步：编译运行

**方式1：使用命令行编译**
```bash
cd frontend
npm install  # 如果还没安装依赖
npm run dev:weapp
```

**方式2：在微信开发工具中编译**
- 点击"编译"按钮
- 等待编译完成

---

### 第五步：验证功能

#### 1. 用户登录 ✅

**测试步骤：**
- 打开小程序
- 点击登录按钮
- 开发环境会自动使用模拟登录（`dev_weapp_mock`）

**预期结果：**
- 登录成功
- 显示用户信息

---

#### 2. 公司风险检测 ✅

**测试步骤：**
1. 进入"公司检测"页面
2. 输入公司名称（如：深圳测试装饰工程有限公司）
3. 点击"开始检测"
4. 等待检测完成

**预期结果：**
- 显示检测进度
- 检测完成后显示风险报告

**注意**：如果检测失败，可能是天眼查API配置问题，不影响其他功能测试。

---

#### 3. 报价单分析 ✅

**测试步骤：**
1. 进入"报价单分析"页面
2. 点击"上传报价单"
3. 选择图片：`2026年深圳住宅装修真实报价单（89㎡三室一厅，半包，中档品质）.png`
4. 等待OCR识别和AI分析

**预期结果：**
- 文件上传成功
- OCR识别完成
- AI分析完成
- 显示总价和风险项

---

#### 4. 合同审核 ✅

**测试步骤：**
1. 进入"合同审核"页面
2. 点击"上传合同"
3. 选择图片：`深圳市住宅装饰装修工程施工合同（半包装修版）.png`
4. 等待OCR识别和AI审核

**预期结果：**
- 文件上传成功
- OCR识别完成
- AI审核完成
- 显示风险条款和修正建议

---

#### 5. 施工进度管理 ✅

**测试步骤：**
1. 进入"施工陪伴"页面
2. 设置开工日期（选择未来日期）
3. 查看6大阶段进度计划
4. 完成S00阶段（材料进场）
5. 验证S01阶段自动解锁

**预期结果：**
- 显示6大阶段（S00-S05）
- S00未锁定，可以操作
- S01被锁定（S00未完成）
- S00完成后，S01自动解锁

---

#### 6. 完整用户旅程 ✅

**测试步骤：**
按照以下顺序测试：
1. 用户登录
2. 公司检测
3. 报价单分析
4. 合同审核
5. 设置开工日期
6. 查看进度计划
7. 完成阶段验收

**预期结果：**
- 所有步骤顺畅执行
- 数据正确保存
- 页面跳转正常

---

## 🔍 调试技巧

### 1. 查看网络请求

在微信开发工具中：
- 打开"调试器" → "Network"
- 查看API请求和响应
- 检查请求URL、请求头、响应状态码

### 2. 查看控制台日志

在微信开发工具中：
- 打开"调试器" → "Console"
- 查看前端日志
- 查看错误信息

### 3. 查看后端日志

如果后端使用nohup启动：
```bash
tail -f backend.log
```

如果直接运行：
- 查看终端输出

---

## ⚠️ 常见问题

### 问题1：网络请求失败

**症状**：小程序中API请求失败

**解决方案：**
1. 确认后端服务正在运行：`curl http://localhost:8000/health`
2. 检查API地址配置是否正确
3. 确认在微信开发工具中勾选了"不校验合法域名"
4. 如果使用本机IP，确认IP地址正确且在同一网络

---

### 问题2：CORS错误

**症状**：浏览器控制台显示CORS错误

**解决方案：**
- 后端已配置CORS中间件，应该不会有问题
- 如果仍有问题，检查 `.env` 中的 `ALLOWED_ORIGINS` 配置

---

### 问题3：登录失败

**症状**：无法登录

**解决方案：**
- 开发环境使用模拟登录：`{"code": "dev_weapp_mock"}`
- 检查后端服务是否正常
- 查看后端日志获取详细错误信息

---

### 问题4：文件上传失败

**症状**：上传图片后没有响应

**解决方案：**
1. 检查文件大小（应≤10MB）
2. 检查文件格式（支持PDF/JPG/PNG）
3. 查看后端日志
4. 如果OCR配置有问题，DEBUG模式下会使用Mock数据

---

### 问题5：AI分析失败

**症状**：上传文件后分析失败

**解决方案：**
1. 检查AI服务配置（DeepSeek/Coze）
2. 查看后端日志获取详细错误
3. DEBUG模式下，OCR失败会使用Mock数据继续AI分析

---

## 📊 验证清单

使用以下清单验证所有功能：

- [ ] 用户登录成功
- [ ] 公司风险检测（如果API配置正常）
- [ ] 报价单上传成功
- [ ] 报价单OCR识别成功
- [ ] 报价单AI分析成功
- [ ] 合同上传成功
- [ ] 合同OCR识别成功
- [ ] 合同AI审核成功
- [ ] 设置开工日期成功
- [ ] 查看进度计划成功
- [ ] 6大阶段显示正常
- [ ] 阶段互锁规则正常
- [ ] S00完成后S01自动解锁
- [ ] 用户数据隔离正常
- [ ] 页面响应速度快（<1.5秒）

---

## 🎯 快速验证命令

**检查后端服务：**
```bash
curl http://localhost:8000/health
```

**测试登录：**
```bash
curl -X POST http://localhost:8000/api/v1/users/login \
  -H "Content-Type: application/json" \
  -d '{"code": "dev_weapp_mock"}'
```

**查看后端日志：**
```bash
tail -f backend.log
```

---

## 📝 测试数据位置

测试文件在项目根目录：
- 报价单：`2026年深圳住宅装修真实报价单（89㎡三室一厅，半包，中档品质）.png`
- 合同：`深圳市住宅装饰装修工程施工合同（半包装修版）.png`

---

## ✅ 当前配置状态

**后端服务：**
- ✅ 运行中：http://localhost:8000
- ✅ 健康检查：正常
- ✅ API文档：http://localhost:8000/api/docs

**前端配置：**
- ⚠️ 需要配置本机IP地址或使用ngrok
- ✅ 微信开发工具配置：已设置不校验域名

**下一步操作：**
1. 获取本机IP地址
2. 修改 `frontend/config/dev.js` 中的API地址
3. 在微信开发工具中打开项目
4. 开始验证功能

---

**祝验证顺利！** 🎉
