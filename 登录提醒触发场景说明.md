# 登录提醒触发场景说明

## 一、用户未登录时，触发登录提醒的场景

### 场景1：用户进入"我的"页面（被动提醒）

**位置**：`frontend/src/pages/profile/index.tsx`

**触发条件**：
- 用户未登录
- 进入"我的"页面（Tabbar底部导航）

**提醒方式**：
- **视觉提醒**：显示登录引导区域
  - 头像占位符：👤
  - 提示文字："登录后查看更多信息"
  - 登录按钮："立即登录"

**代码位置**：第167-173行
```typescript
<View className='login-cta'>
  <Text className='avatar-placeholder'>👤</Text>
  <Text className='login-text'>登录后查看更多信息</Text>
  <View className='login-btn' onClick={handleLogin}>
    <Text>立即登录</Text>
  </View>
</View>
```

**特点**：
- ✅ 被动提醒（页面显示）
- ✅ 不强制登录（用户可以继续浏览其他功能）
- ✅ 用户主动点击"立即登录"按钮才会触发登录流程

---

### 场景2：用户尝试上传报价单（主动提醒）

**位置**：`frontend/src/pages/quote-upload/index.tsx`

**触发条件**：
- 用户未登录
- 用户选择了文件
- 用户点击"开始分析"按钮

**提醒方式**：
- **弹窗提醒**：显示确认弹窗
  - 标题："需要登录"
  - 内容："此功能需要登录，是否前往登录？"
  - 按钮："去登录" / "取消"

**代码位置**：第63-80行
```typescript
const handleUpload = async () => {
  if (!file) {
    Taro.showToast({ title: '请先选择或拍摄文件', icon: 'none' })
    return
  }
  
  // 检查登录状态
  if (!checkLogin()) {
    return  // 显示登录提醒弹窗
  }
  
  // 继续上传逻辑...
}
```

**特点**：
- ✅ 主动提醒（弹窗拦截）
- ✅ 阻止操作（必须先登录才能上传）
- ✅ 用户确认后跳转到"我的"页面

---

### 场景3：用户尝试上传合同（主动提醒）

**位置**：`frontend/src/pages/contract-upload/index.tsx`

**触发条件**：
- 用户未登录
- 用户选择了文件
- 用户点击"开始审核"按钮

**提醒方式**：
- **弹窗提醒**：显示确认弹窗
  - 标题："需要登录"
  - 内容："此功能需要登录，是否前往登录？"
  - 按钮："去登录" / "取消"

**代码位置**：第63-79行
```typescript
const handleUpload = async () => {
  if (!file) {
    Taro.showToast({ title: '请先选择或拍摄文件', icon: 'none' })
    return
  }
  
  // 检查登录状态
  if (!checkLogin()) {
    return  // 显示登录提醒弹窗
  }
  
  // 继续上传逻辑...
}
```

**特点**：
- ✅ 主动提醒（弹窗拦截）
- ✅ 阻止操作（必须先登录才能上传）
- ✅ 用户确认后跳转到"我的"页面

---

### 场景4：Token过期时（被动提醒）

**位置**：`frontend/src/services/api.ts` 响应拦截器

**触发条件**：
- 用户已登录但Token过期
- 调用需要认证的API接口
- 后端返回401状态码

**提醒方式**：
- **弹窗提醒**：延迟显示确认弹窗
  - 标题："登录已过期"
  - 内容："您的登录已过期，请前往'我的'页面重新登录"
  - 按钮："知道了"（无取消按钮）

**代码位置**：第79-103行
```typescript
case 401:
  message = '登录已过期，请重新登录'
  Taro.removeStorageSync('access_token')
  Taro.removeStorageSync('user_id')
  
  const hasOnboarded = Taro.getStorageSync('onboarding_completed') || Taro.getStorageSync('has_onboarded')
  if (hasOnboarded) {
    Taro.reLaunch({ url: '/pages/index/index' })
    setTimeout(() => {
      Taro.showModal({
        title: '登录已过期',
        content: '您的登录已过期，请前往"我的"页面重新登录',
        showCancel: false,
        confirmText: '知道了'
      })
    }, 500)
  }
  break
```

**特点**：
- ✅ 被动提醒（API请求失败时触发）
- ✅ 自动清除过期Token
- ✅ 跳转到首页，然后显示提示
- ✅ 用户需要手动前往"我的"页面重新登录

**可能触发的操作**：
- 查看报告列表
- 查看施工进度
- 上传文件
- 查看用户信息
- 任何需要认证的API请求

---

## 二、不会触发登录提醒的场景

### 场景1：小程序启动时自动登录（开发环境）

**位置**：`frontend/src/app.tsx`

**触发条件**：
- 小程序启动
- 本地没有token
- 开发/体验版环境

**行为**：
- ✅ 静默尝试登录（使用 `dev_weapp_mock`）
- ❌ **不会显示任何提示给用户**
- ❌ 失败时只在控制台记录日志

**代码位置**：第12-44行
```typescript
function useDevSilentLogin() {
  React.useEffect(() => {
    // ... 静默登录逻辑
    // 失败时只记录日志，不提示用户
    console.error('[自动登录] 开发环境自动登录失败:', err)
  }, [])
}
```

---

### 场景2：浏览不需要登录的功能

**以下功能不需要登录，不会触发登录提醒**：
- ✅ 查看首页
- ✅ 浏览引导页
- ✅ 查看使用指南
- ✅ 查看隐私保障
- ✅ 查看关于页面
- ✅ 公司名称搜索（仅搜索，不提交检测）
- ✅ 查看示例图片

---

## 三、登录提醒触发场景汇总表

| 场景 | 触发条件 | 提醒方式 | 是否强制 | 跳转目标 | 代码位置 |
|------|---------|---------|---------|---------|---------|
| **1. 进入"我的"页面** | 未登录 + 进入页面 | 视觉提醒（登录按钮） | ❌ 否 | - | `profile/index.tsx:167-173` |
| **2. 上传报价单** | 未登录 + 点击"开始分析" | 弹窗提醒 | ✅ 是 | "我的"页面 | `quote-upload/index.tsx:71` |
| **3. 上传合同** | 未登录 + 点击"开始审核" | 弹窗提醒 | ✅ 是 | "我的"页面 | `contract-upload/index.tsx:71` |
| **4. Token过期** | Token过期 + API请求 | 弹窗提醒 | ✅ 是 | 首页 → "我的"页面 | `services/api.ts:93-98` |

---

## 四、登录提醒的详细流程

### 流程1：用户主动使用需要登录的功能

```
用户未登录
    ↓
用户尝试上传报价单/合同
    ↓
选择文件后点击"开始分析/审核"
    ↓
checkLogin() 检查登录状态
    ↓
未登录 → 显示弹窗："需要登录，是否前往登录？"
    ↓
用户点击"去登录" → 跳转到"我的"页面
    ↓
用户点击"立即登录"按钮
    ↓
执行登录流程
```

### 流程2：Token过期

```
用户已登录（Token过期）
    ↓
调用需要认证的API
    ↓
后端返回401（未授权）
    ↓
响应拦截器捕获401错误
    ↓
清除本地Token和用户ID
    ↓
检查是否已完成引导
    ↓
已完成引导 → 跳转到首页
    ↓
延迟500ms显示弹窗："登录已过期，请前往'我的'页面重新登录"
    ↓
用户点击"知道了"
    ↓
用户需要手动前往"我的"页面重新登录
```

### 流程3：用户进入"我的"页面

```
用户未登录
    ↓
点击Tabbar"我的"
    ↓
进入"我的"页面
    ↓
显示登录引导区域
    - 头像占位符
    - "登录后查看更多信息"
    - "立即登录"按钮
    ↓
用户点击"立即登录"
    ↓
执行登录流程
```

---

## 五、登录提醒的UI展示

### 1. "我的"页面登录引导

**位置**：`frontend/src/pages/profile/index.tsx`

**UI元素**：
- 头像占位符：👤
- 提示文字："登录后查看更多信息"（28rpx，白色半透明）
- 登录按钮："立即登录"（主色背景，白色文字）

**样式**：`.login-cta` 类

---

### 2. 功能登录提醒弹窗

**位置**：`frontend/src/utils/auth.ts` 的 `checkLogin()` 函数

**弹窗内容**：
- 标题："需要登录"
- 内容："此功能需要登录，是否前往登录？"
- 确认按钮："去登录"
- 取消按钮："取消"

**实现**：`Taro.showModal()`

---

### 3. Token过期提醒弹窗

**位置**：`frontend/src/services/api.ts` 响应拦截器

**弹窗内容**：
- 标题："登录已过期"
- 内容："您的登录已过期，请前往'我的'页面重新登录"
- 确认按钮："知道了"（无取消按钮）

**实现**：`Taro.showModal()`（`showCancel: false`）

---

## 六、不会触发登录提醒的情况

### 1. 自动登录（开发环境）

- **位置**：`app.tsx` 的 `useDevSilentLogin()`
- **行为**：静默尝试登录，失败时不提示用户
- **原因**：开发环境便利性，避免打扰用户

### 2. 浏览公开功能

以下功能不需要登录，不会触发提醒：
- 首页浏览
- 引导页
- 使用指南
- 隐私保障
- 关于页面
- 公司名称搜索（仅搜索）

### 3. 查看报告详情（如果已解锁）

- 如果报告已解锁（本地标记），可以查看
- 但需要登录才能解锁新报告

---

## 七、总结

### 会触发登录提醒的场景（4种）

1. ✅ **进入"我的"页面**：视觉提醒（登录按钮）
2. ✅ **上传报价单**：弹窗提醒（阻止操作）
3. ✅ **上传合同**：弹窗提醒（阻止操作）
4. ✅ **Token过期**：弹窗提醒（API请求失败时）

### 不会触发登录提醒的场景

1. ❌ **自动登录失败**：静默失败，只记录日志
2. ❌ **浏览公开功能**：不需要登录
3. ❌ **查看已解锁内容**：本地已解锁的报告可以查看

### 登录提醒的特点

- **主动提醒**：使用需要登录的功能时（上传文件）
- **被动提醒**：进入"我的"页面、Token过期时
- **强制登录**：上传文件、Token过期时必须登录
- **非强制登录**：浏览"我的"页面时建议登录但不强制

---

**文档生成时间**：2026-02-10  
**检查范围**：前端所有页面和工具函数
