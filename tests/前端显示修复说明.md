# 前端报价单分析结果显示修复说明

## 问题发现

前端`report-detail/index.tsx`页面在显示报价单分析报告时：
- ❌ **未调用API**：使用的是硬编码的示例数据（第56-60行）
- ❌ **未解析后端数据**：没有处理`result_json`、`high_risk_items`等字段
- ❌ **风险等级错误**：使用随机值而不是根据`risk_score`计算

## 修复内容

### 1. 添加API调用
- 导入`quoteApi`
- 在`useEffect`中添加报价单类型的API调用逻辑
- 调用`quoteApi.getAnalysis(quoteId)`获取分析结果

### 2. 添加数据转换函数
新增`mapQuoteToItems`函数，将后端返回的报价单分析结果转换为前端显示格式：

```typescript
function mapQuoteToItems(data: {
  high_risk_items?: Array<...>
  warning_items?: Array<...>
  missing_items?: Array<...>
  overpriced_items?: Array<...>
  suggestions?: string[]
  result_json?: {...}
}): Array<{ tag: string; text: string }>
```

**转换逻辑**：
- `high_risk_items` → "漏项"或"高风险"标签
- `warning_items` → "警告"或"虚高"标签
- `missing_items` → "漏项"标签
- `overpriced_items` → "虚高"标签
- `suggestions` → "建议"标签

**数据来源优先级**：
1. 优先使用`result_json`中的数据（完整的AI分析结果）
2. 如果没有，则使用顶层字段（`high_risk_items`等）

### 3. 风险等级计算
根据`risk_score`确定风险等级：
- `risk_score >= 61` → `high`（高风险）
- `risk_score >= 31` → `warning`（警告）
- `risk_score < 31` → `compliant`（合规）

### 4. 错误处理
- API调用失败时，使用默认示例数据作为fallback
- 添加`console.error`记录错误信息

## 数据流程

```
后端API返回
  ↓
GET /api/v1/quotes/quote/:id
  ↓
{
  risk_score: 65,
  high_risk_items: [...],
  warning_items: [...],
  missing_items: [...],
  overpriced_items: [...],
  result_json: {
    risk_score: 65,
    high_risk_items: [...],
    ...
  }
}
  ↓
mapQuoteToItems() 转换
  ↓
前端显示
  - 风险等级：⚠️ 1项警告（根据risk_score=65计算）
  - 风险项列表：显示所有high_risk_items、warning_items等
```

## 测试建议

1. **测试正常流程**：
   - 上传报价单
   - 等待分析完成
   - 打开报告详情页
   - 验证显示的风险项、警告项、漏项、虚高项是否正确

2. **测试数据来源**：
   - 验证优先使用`result_json`中的数据
   - 如果没有`result_json`，验证使用顶层字段

3. **测试风险等级**：
   - 测试不同`risk_score`值（0-30, 31-60, 61-100）
   - 验证风险等级显示是否正确

4. **测试错误处理**：
   - 模拟API调用失败
   - 验证是否显示默认数据

## 相关文件

- `frontend/src/pages/report-detail/index.tsx` - 报告详情页
- `frontend/src/services/api.ts` - API服务（`quoteApi.getAnalysis`）

## 下一步

1. ✅ 已修复前端代码
2. ⏳ 需要测试验证显示效果
3. ⏳ 确认后端修复（market_ref_price类型问题）后，重新测试完整流程
