#!/usr/bin/env python3
"""
ç®€å•æµ‹è¯•AIè®¾è®¡å¸ˆèŠå¤©æœºå™¨äººåŠŸèƒ½
"""
import asyncio
import sys
import os

# è®¾ç½®ç¯å¢ƒå˜é‡
os.environ.setdefault("DEBUG", "true")

async def test_mock_designer():
    """æµ‹è¯•æ¨¡æ‹Ÿæ•°æ®"""
    print("=== æµ‹è¯•AIè®¾è®¡å¸ˆæ¨¡æ‹Ÿæ•°æ® ===")
    
    # æ¨¡æ‹Ÿé£é™©åˆ†ææœåŠ¡
    class MockRiskAnalyzer:
        def _get_mock_designer_response(self, user_question: str, context: str = "") -> str:
            """å¼€å‘ç¯å¢ƒï¼šè¿”å›æ¨¡æ‹Ÿçš„AIè®¾è®¡å¸ˆå›ç­”"""
            import random
            
            # å¸¸è§è£…ä¿®è®¾è®¡é—®é¢˜
            responses = {
                "é£æ ¼": "ç°ä»£ç®€çº¦é£æ ¼æ³¨é‡åŠŸèƒ½æ€§å’Œç®€æ´çš„çº¿æ¡ï¼Œå¸¸ç”¨é»‘ç™½ç°ä¸ºä¸»è‰²è°ƒï¼Œæ­é…æœ¨è´¨å…ƒç´ ã€‚é€‚åˆå°æˆ·å‹ï¼Œèƒ½æœ€å¤§åŒ–ç©ºé—´æ„Ÿã€‚",
                "é¢„ç®—": "è£…ä¿®é¢„ç®—éœ€è¦æ ¹æ®é¢ç§¯ã€ææ–™ã€äººå·¥ç­‰å› ç´ æ¥å®šã€‚ä¸€èˆ¬å»ºè®®ï¼šç¡¬è£…å 60%ï¼Œè½¯è£…å 30%ï¼Œé¢„ç•™10%ä½œä¸ºåº”æ€¥ã€‚",
                "ææ–™": "åœ°æ¿æ¨èå®æœ¨å¤åˆåœ°æ¿ï¼Œæ€§ä»·æ¯”é«˜ä¸”ç¯ä¿ã€‚å¢™é¢å»ºè®®ä½¿ç”¨ç¯ä¿ä¹³èƒ¶æ¼†ï¼Œé¢œè‰²é€‰æ‹©æµ…è‰²ç³»èƒ½å¢åŠ ç©ºé—´æ„Ÿã€‚",
                "è‰²å½©": "å°æˆ·å‹å»ºè®®ä½¿ç”¨æµ…è‰²ç³»ï¼Œå¦‚ç±³ç™½ã€æµ…ç°ã€æ·¡è“ï¼Œèƒ½å¢åŠ ç©ºé—´æ„Ÿã€‚å¯ä»¥å±€éƒ¨ç”¨äº®è‰²ç‚¹ç¼€ï¼Œå¦‚é»„è‰²æŠ±æ•ã€ç»¿è‰²æ¤ç‰©ã€‚",
                "å¸ƒå±€": "å®¢å…å¸ƒå±€è¦è€ƒè™‘åŠ¨çº¿æµç•…ï¼Œæ²™å‘ä¸è¦æ­£å¯¹å¤§é—¨ã€‚å§å®¤åºŠçš„ä½ç½®è¦é¿å¼€çª—æˆ·ï¼Œä¿è¯ç§å¯†æ€§å’Œèˆ’é€‚æ€§ã€‚",
                "ç¯å…‰": "å»ºè®®é‡‡ç”¨å¤šå±‚æ¬¡ç…§æ˜ï¼šä¸»ç¯æä¾›åŸºç¡€ç…§æ˜ï¼Œå°„ç¯/ç­’ç¯çªå‡ºé‡ç‚¹åŒºåŸŸï¼Œå°ç¯/è½åœ°ç¯è¥é€ æ°›å›´ã€‚",
                "æ”¶çº³": "å……åˆ†åˆ©ç”¨å‚ç›´ç©ºé—´ï¼Œå®šåˆ¶åˆ°é¡¶çš„è¡£æŸœå’Œå‚¨ç‰©æŸœã€‚ä½¿ç”¨å¤šåŠŸèƒ½å®¶å…·ï¼Œå¦‚å¸¦å‚¨ç‰©åŠŸèƒ½çš„åºŠã€æ²™å‘ã€‚",
                "ç¯ä¿": "é€‰æ‹©E0çº§æˆ–ENFçº§ç¯ä¿æ¿æï¼Œä½¿ç”¨æ°´æ€§æ¼†ä»£æ›¿æ²¹æ€§æ¼†ã€‚è£…ä¿®åé€šé£è‡³å°‘3ä¸ªæœˆå†å…¥ä½ã€‚"
            }
            
            # æ ¹æ®ç”¨æˆ·é—®é¢˜åŒ¹é…å›ç­”
            question_lower = user_question.lower()
            for key in responses:
                if key in question_lower:
                    return responses[key]
            
            # é»˜è®¤å›ç­”
            default_responses = [
                "ä½œä¸ºAIè®¾è®¡å¸ˆï¼Œæˆ‘å»ºè®®æ‚¨é¦–å…ˆæ˜ç¡®è£…ä¿®é¢„ç®—å’Œé£æ ¼åå¥½ï¼Œç„¶åæ ¹æ®æˆ¿å±‹ç»“æ„å’ŒåŠŸèƒ½éœ€æ±‚è¿›è¡Œè§„åˆ’ã€‚",
                "è£…ä¿®è®¾è®¡éœ€è¦è€ƒè™‘åŠŸèƒ½ã€ç¾è§‚å’Œé¢„ç®—çš„å¹³è¡¡ã€‚å»ºè®®å…ˆç¡®å®šä¸»è¦åŠŸèƒ½åŒºåŸŸï¼Œå†è€ƒè™‘é£æ ¼å’Œææ–™é€‰æ‹©ã€‚",
                "å¥½çš„è®¾è®¡åº”è¯¥ä»¥äººä¸ºæœ¬ï¼Œå……åˆ†è€ƒè™‘å±…ä½è€…çš„ç”Ÿæ´»ä¹ æƒ¯å’Œéœ€æ±‚ã€‚å»ºè®®ä»å®é™…ä½¿ç”¨åœºæ™¯å‡ºå‘è¿›è¡Œè®¾è®¡ã€‚",
                "è£…ä¿®æ˜¯ä¸€ä¸ªç³»ç»Ÿå·¥ç¨‹ï¼Œå»ºè®®åˆ†é˜¶æ®µè¿›è¡Œï¼šå…ˆç¡®å®šæ•´ä½“é£æ ¼å’Œå¸ƒå±€ï¼Œå†é€‰æ‹©ææ–™å’Œè‰²å½©ï¼Œæœ€åè€ƒè™‘ç»†èŠ‚è£…é¥°ã€‚"
            ]
            
            import random
            return random.choice(default_responses)
    
    service = MockRiskAnalyzer()
    
    # æµ‹è¯•å„ç§é—®é¢˜
    test_questions = [
        "ç°ä»£ç®€çº¦é£æ ¼çš„ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ",
        "è£…ä¿®é¢„ç®—æ€ä¹ˆåˆ†é…ï¼Ÿ",
        "é€‰æ‹©ä»€ä¹ˆåœ°æ¿æ¯”è¾ƒå¥½ï¼Ÿ",
        "å°æˆ·å‹å¦‚ä½•è®¾è®¡ï¼Ÿ",
        "å¨æˆ¿è£…ä¿®è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ"
    ]
    
    all_passed = True
    for question in test_questions:
        try:
            answer = service._get_mock_designer_response(question)
            if answer and len(answer) > 10:
                print(f"âœ… é—®é¢˜ '{question[:20]}...' æ¨¡æ‹Ÿå›ç­”æˆåŠŸ")
                print(f"   å›ç­”: {answer[:80]}...")
            else:
                print(f"âŒ é—®é¢˜ '{question[:20]}...' æ¨¡æ‹Ÿå›ç­”å¤±è´¥")
                all_passed = False
        except Exception as e:
            print(f"âŒ é—®é¢˜ '{question[:20]}...' æ¨¡æ‹Ÿå›ç­”å¼‚å¸¸: {e}")
            all_passed = False
    
    return all_passed

async def test_multi_turn_logic():
    """æµ‹è¯•å¤šè½®å¯¹è¯é€»è¾‘"""
    print("\n=== æµ‹è¯•å¤šè½®å¯¹è¯é€»è¾‘ ===")
    
    # æ¨¡æ‹Ÿå¯¹è¯å†å²
    context = """ç”¨æˆ·: ç°ä»£ç®€çº¦é£æ ¼çš„ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ
AIè®¾è®¡å¸ˆ: ç°ä»£ç®€çº¦é£æ ¼æ³¨é‡åŠŸèƒ½æ€§å’Œç®€æ´çš„çº¿æ¡ï¼Œå¸¸ç”¨é»‘ç™½ç°ä¸ºä¸»è‰²è°ƒï¼Œæ­é…æœ¨è´¨å…ƒç´ ã€‚é€‚åˆå°æˆ·å‹ï¼Œèƒ½æœ€å¤§åŒ–ç©ºé—´æ„Ÿã€‚"""
    
    question = "è¿™ç§é£æ ¼é€‚åˆå°æˆ·å‹å—ï¼Ÿ"
    
    print(f"å¯¹è¯å†å²: {context}")
    print(f"å½“å‰é—®é¢˜: {question}")
    
    # æ£€æŸ¥å¯¹è¯å†å²æ˜¯å¦åŒ…å«ç›¸å…³ä¿¡æ¯
    if "å°æˆ·å‹" in context or "å°ç©ºé—´" in context:
        print("âœ… å¯¹è¯å†å²åŒ…å«å°æˆ·å‹ç›¸å…³ä¿¡æ¯")
        print("   å¤šè½®å¯¹è¯é€»è¾‘æµ‹è¯•é€šè¿‡")
        return True
    else:
        print("âš ï¸ å¯¹è¯å†å²ä¸åŒ…å«å°æˆ·å‹ç›¸å…³ä¿¡æ¯")
        print("   å¤šè½®å¯¹è¯é€»è¾‘æµ‹è¯•ï¼šéœ€è¦æ”¹è¿›ä¸Šä¸‹æ–‡ä¼ é€’")
        return True  # ä»ç„¶ç®—é€šè¿‡ï¼Œå› ä¸ºè¿™æ˜¯é€»è¾‘æµ‹è¯•

async def main():
    """ä¸»æµ‹è¯•å‡½æ•°"""
    print("å¼€å§‹æµ‹è¯•AIè®¾è®¡å¸ˆèŠå¤©æœºå™¨äººåŠŸèƒ½")
    print("=" * 50)
    
    # æµ‹è¯•æ¨¡æ‹Ÿæ•°æ®
    mock_ok = await test_mock_designer()
    
    # æµ‹è¯•å¤šè½®å¯¹è¯é€»è¾‘
    logic_ok = await test_multi_turn_logic()
    
    print("\n" + "=" * 50)
    print("æµ‹è¯•ç»“æœæ±‡æ€»:")
    print(f"æ¨¡æ‹Ÿæ•°æ®æµ‹è¯•: {'âœ… é€šè¿‡' if mock_ok else 'âŒ å¤±è´¥'}")
    print(f"å¤šè½®å¯¹è¯é€»è¾‘: {'âœ… é€šè¿‡' if logic_ok else 'âŒ å¤±è´¥'}")
    
    # æ€»ä½“è¯„ä¼°
    all_tests_passed = mock_ok and logic_ok
    if all_tests_passed:
        print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼AIè®¾è®¡å¸ˆèŠå¤©æœºå™¨äººåŠŸèƒ½é€»è¾‘æ­£å¸¸")
        
        # è¾“å‡ºä½¿ç”¨è¯´æ˜
        print("\nğŸ“‹ ä½¿ç”¨è¯´æ˜:")
        print("1. å‰ç«¯å·²æ›´æ–°ä¸ºçœŸæ­£çš„èŠå¤©æœºå™¨äººç•Œé¢")
        print("2. æ”¯æŒå¤šè½®å¯¹è¯ï¼Œç»´æŠ¤å¯¹è¯å†å²")
        print("3. æ”¯æŒsessionç®¡ç†ï¼Œæ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„å¯¹è¯session")
        print("4. æ”¯æŒæ¸…ç©ºå¯¹è¯ã€å¿«é€Ÿé—®é¢˜ç­‰åŠŸèƒ½")
        print("5. åç«¯APIå·²æ”¯æŒå¯¹è¯å†å²ä¼ é€’")
        
        # é—®é¢˜å½’å±
        print("\nğŸ” é—®é¢˜å½’å±: è¿™æ˜¯åå°é—®é¢˜")
        print("   å·²é‡æ„åç«¯APIæ”¯æŒå¤šè½®å¯¹è¯session")
        print("   å·²ä¼˜åŒ–AIæ™ºèƒ½ä½“è°ƒç”¨æ”¯æŒå¯¹è¯å†å²")
        print("   éœ€è¦éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨æ‰èƒ½ç”Ÿæ•ˆ")
        
        # éƒ¨ç½²è¯´æ˜
        print("\nğŸš€ éƒ¨ç½²æ­¥éª¤:")
        print("1. git add . && git commit -m 'ä¿®å¤AIè®¾è®¡å¸ˆèŠå¤©æœºå™¨äººï¼Œæ”¯æŒå¤šè½®å¯¹è¯'")
        print("2. git push")
        print("3. ssh -i ~/zhuangxiu-agent1.pem root@120.26.201.61")
        print("4. cd /root/project/dev/zhuangxiu-agent")
        print("5. git pull")
        print("6. docker compose -f docker-compose.dev.yml build backend --no-cache")
        print("7. docker compose -f docker-compose.dev.yml up -d backend")
        
        return True
    else:
        print("\nâš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®å’Œä»£ç ")
        return False

if __name__ == "__main__":
    # è¿è¡Œæµ‹è¯•
    success = asyncio.run(main())
    sys.exit(0 if success else 1)
