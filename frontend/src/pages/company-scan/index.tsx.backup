import React, { useState, useEffect } from 'react'
import { View, Text, Input, ScrollView } from '@tarojs/components'
import Taro from '@tarojs/taro'
import { companyApi } from '../../services/api'
import { useCompanyStore } from '../../store'
import './index.scss'

/**
 * 公司风险扫描页面
 */
const CompanyScan: React.FC = () => {
  const [companyName, setCompanyName] = useState('')
  const [loading, setLoading] = useState(false)
  const [scanResult, setScanResult] = useState<any>(null)
  const [showResult, setShowResult] = useState(false)

  const { setCurrentScan } = useCompanyStore()

  // 模糊匹配建议
  const [suggestions, setSuggestions] = useState<string[]>([])
  const [showSuggestions, setShowSuggestions] = useState(false)

  // 公司名称输入处理
  const handleInput = (e: any) => {
    const value = e.detail.value
    setCompanyName(value)

    // 输入≥3个字符时显示模糊匹配
    if (value.length >= 3) {
      const mockSuggestions = [
        `杭州${value}装饰有限公司`,
        `上海${value}工程有限公司`,
        `${value}装饰设计有限公司`
      ]
      setSuggestions(mockSuggestions)
      setShowSuggestions(true)
    } else {
      setShowSuggestions(false)
    }
  }

  // 选择建议
  const selectSuggestion = (suggestion: string) => {
    setCompanyName(suggestion)
    setShowSuggestions(false)
  }

  // 开始检测
  const handleScan = async () => {
    if (!companyName.trim()) {
      Taro.showToast({
        title: '请输入公司名称',
        icon: 'none'
      })
      return
    }

    setLoading(true)
    try {
      const result = await companyApi.scan(companyName)
      setCurrentScan(result)

      // 轮询检测结果
      pollResult(result.task_id)

    } catch (error) {
      Taro.showToast({
        title: '检测失败',
        icon: 'none'
      })
      setLoading(false)
    }
  }

  // 轮询检测结果
  const pollResult = async (taskId: number) => {
    const maxAttempts = 30 // 最多轮询30次
    let attempts = 0

    const poll = async () => {
      try {
        const result = await companyApi.getResult(taskId)

        if (result.status === 'completed') {
          setScanResult(result)
          setShowResult(true)
          setLoading(false)

          // 保存到本地
          Taro.setStorageSync('has_company_scan', true)
          Taro.setStorageSync('last_company_scan', result)

          Taro.showToast({
            title: '检测完成',
            icon: 'success'
          })
        } else if (result.status === 'failed') {
          setLoading(false)
          Taro.showToast({
            title: '检测失败',
            icon: 'none'
          })
        } else {
          // 继续轮询
          attempts++
          if (attempts < maxAttempts) {
            setTimeout(poll, 2000)
          } else {
            setLoading(false)
            Taro.showToast({
              title: '检测超时',
              icon: 'none'
            })
          }
        }
      } catch (error) {
        setLoading(false)
        Taro.showToast({
          title: '获取结果失败',
          icon: 'none'
        })
      }
    }

    poll()
  }

  // 查看历史记录
  const viewHistory = () => {
    Taro.navigateTo({
      url: '/pages/company-history/index'
    })
  }

  // 返回首页
  const goHome = () => {
    Taro.switchTab({
      url: '/pages/index/index'
    })
  }

  return (
    <ScrollView scrollY className='company-scan-page'>
      <View className='header'>
        <Text className='title'>装修公司风险检测</Text>
        <Text className='subtitle' onClick={viewHistory}>查看历史</Text>
      </View>

      <View className='content'>
        {/* 输入框 */}
        <View className='input-container'>
          <Text className='label'>公司名称</Text>
          <View className='input-wrapper'>
            <Input
              className='input'
              placeholder='例如：杭州生活家装饰有限公司'
              value={companyName}
              onInput={handleInput}
              placeholderClass='placeholder'
            />
            {companyName && (
              <Text className='clear-btn' onClick={() => setCompanyName('')}>×</Text>
            )}
          </View>

          {/* 模糊匹配建议 */}
          {showSuggestions && suggestions.length > 0 && (
            <View className='suggestions'>
              {suggestions.map((suggestion, index) => (
                <View
                  key={index}
                  className='suggestion-item'
                  onClick={() => selectSuggestion(suggestion)}
                >
                  <Text>{suggestion}</Text>
                </View>
              ))}
            </View>
          )}

          <Text className='hint'>请输入完整公司名称，确保检测结果准确</Text>
        </View>

        {/* 检测按钮 */}
        <View
          className={`scan-btn ${loading ? 'disabled' : ''} ${companyName ? 'active' : ''}`}
          onClick={!loading ? handleScan : undefined}
        >
          {loading ? (
            <Text className='btn-text'>检测中...</Text>
          ) : (
            <Text className='btn-text'>开始检测</Text>
          )}
        </View>

        {/* 检测须知 */}
        <View className='notice'>
          <Text className='notice-text'>
            检测数据来源于公开工商信息/投诉平台，仅供参考
          </Text>
        </View>

        {/* 检测结果 */}
        {showResult && scanResult && (
          <View className='result-container'>
            <View className='result-header'>
              <Text className='result-title'>检测报告</Text>
              <Text className='result-time'>
                {new Date(scanResult.created_at).toLocaleString()}
              </Text>
            </View>

            {/* 风险等级 */}
            <View className={`risk-level ${scanResult.risk_level}`}>
              {scanResult.risk_level === 'high' && (
                <Text className='risk-text'>⚠️ 高风险</Text>
              )}
              {scanResult.risk_level === 'warning' && (
                <Text className='risk-text'>⚠️ 警告</Text>
              )}
              {scanResult.risk_level === 'compliant' && (
                <Text className='risk-text'>✅ 合规</Text>
              )}
            </View>

            {/* 风险评分 */}
            <View className='risk-score'>
              <Text className='score-label'>风险评分</Text>
              <Text className='score-value'>{scanResult.risk_score}/100</Text>
            </View>

            {/* 风险原因 */}
            {scanResult.risk_reasons && scanResult.risk_reasons.length > 0 && (
              <View className='risk-reasons'>
                <Text className='section-title'>风险原因</Text>
                {scanResult.risk_reasons.map((reason: string, index: number) => (
                  <View key={index} className='reason-item'>
                    <Text className='reason-dot'>•</Text>
                    <Text className='reason-text'>{reason}</Text>
                  </View>
                ))}
              </View>
            )}

            {/* 投诉记录 */}
            {scanResult.complaint_count > 0 && (
              <View className='complaint-info'>
                <Text className='section-title'>投诉记录</Text>
                <Text className='complaint-count'>
                  共 {scanResult.complaint_count} 条投诉
                </Text>
              </View>
            )}

            {/* 法律风险 */}
            {scanResult.legal_risks && scanResult.legal_risks.length > 0 && (
              <View className='legal-risks'>
                <Text className='section-title'>法律诉讼</Text>
                {scanResult.legal_risks.map((risk: any, index: number) => (
                  <View key={index} className='risk-item'>
                    <Text className='risk-item-title'>{risk.title}</Text>
                    <Text className='risk-item-desc'>{risk.description}</Text>
                  </View>
                ))}
              </View>
            )}

            {/* 返回按钮 */}
            <View className='back-btn' onClick={goHome}>
              <Text className='back-text'>返回首页</Text>
            </View>
          </View>
        )}
      </View>
    </ScrollView>
  )
}

export default CompanyScan
