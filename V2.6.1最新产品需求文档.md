# V2.6.2（优化版）装修避坑管家微信小程序 - 产品需求文档
**版本**：V2.6.8（基于V2.6.7，验收流程优化）
**更新日期**：2026年02月16日
**适用范围**：微信小程序（iOS/Android）
**关联原型**：装修决策Agent 微信小程序原型文档（V15.3）
**核心目标**：在V2.6.1基础上，优化代码架构、用户体验和商业模式，提升产品竞争力。
**更新说明**：
- **V2.6.1**：基于原型V15.3优化34项核心差异点，新增材料进场人工核对页（P37）、城市选择页（P38）
- **V2.6.2**：代码架构优化（删除冗余API）、用户体验优化（首次使用体验、付费转化）、商业模式优化（会员权益提升）
- **P29 装修日历（方案A）**：6大阶段计划/验收节点完整计算、月/周视图、底部图例、「前往阶段」跳转P09并滚动到对应阶段
- **V2.6.7**：新增积分系统（分享奖励）、优化P30验收报告页UI（申诉移至底部、分享按钮优化）、修复顶部安全区域遮挡问题
- **V2.6.8**：新增邀请系统，所有分享页统一添加"邀请好友得1次免费报告解锁"功能，支持免费解锁权益使用

## 目录
1. [产品概述](#一产品概述)
2. [全量页面功能需求](#二全量页面功能需求)
3. [非功能需求](#三非功能需求)
4. [版本差异说明](#四版本差异说明)
5. [附录](#五附录)
6. [核心业务闭环规则](#六核心业务闭环规则)
7. [AI能力落地规范](#七ai能力落地规范)
8. [城市本地化知识库规范](#八城市本地化知识库规范)
9. [AI监理咨询与收费规范](#九ai监理咨询与收费规范)

## 一、产品概述
### 1.1 产品定位
「装修避坑管家」是面向装修用户的一站式智能决策工具，聚焦装修前的公司资质核验、报价单审核、合同风险识别，以及装修中的施工进度管理、**阶段化AI专项验收+材料进场人工核对**，通过「自有部署AI技术+城市本地化知识库+AI监理咨询」帮助普通用户规避装修陷阱，降低决策风险，核心价值是「精准本地化的中立AI装修顾问」，支持自主装修/装修公司合作双模式，覆盖全装修周期避坑需求。

### 1.2 目标用户（补充细分）
| 用户类型 | 特征                                             | 核心痛点                                     | 专属适配方案                                                 |
| :------- | :----------------------------------------------- | :------------------------------------------- | :----------------------------------------------------------- |
| 主力用户 | 25-40岁首次装修家庭，预算15-50万，与装修公司合作 | 不懂装修流程、怕被增项/跑路、合同/报价看不懂 | 全流程AI验收+进度联动+公司风险检测+AI监理咨询+人工监理直通   |
| 次级用户 | 小户型改造/老房翻新者，预算5-15万                | 预算紧、工期敏感、隐蔽工程风险高             | 轻量化验收+本地主材市场价精准匹配+工期预警精细化+AI监理快速答疑 |
| 特殊用户 | 自主装修用户，无合作装修公司                     | 无专业验收能力、不懂本地规范、进度无监督     | 验收豁免申请+人工答疑优先+装修流程定制化指引+AI监理DIY指导   |

### 1.3 核心价值主张（对齐原型V15.3）
- 避坑：覆盖90%装修常见风险，阶段化AI专项验收+材料人工核对精准识别问题，支持验收争议申诉
- 省钱：通过报价审核避免隐藏增项，AI验收提前发现问题避免返工成本，付费权益边界清晰
- 省心：AI自动化分析+施工节点智能提醒（微信+小程序双重触达）+ 验收结果联动进度，核心操作一步直达
- 中立：不向装修公司收费，所有建议基于客观数据与本地行业规范
- 安全：AI分析全流程自有部署，用户数据加密存储，删除/存储规则透明
- 本地精准：基于城市本地化知识库，提供符合当地实际的装修建议
- 智能答疑：验收报告页提供AI监理咨询入口，复杂问题无缝转接人工监理
- 流程互锁：前置阶段未通过则后续阶段强制锁定，无绕过可能，确保施工规范性

### 1.4 核心约束（对齐原型V15.3）
- 合规约束：遵循《个人信息保护法》《住宅室内装饰装修管理办法》，AI分析结果标注场景化免责声明
- 性能约束：报告生成时间≤8秒，页面加载≤1.5秒，AI验收分析≤10秒，AI监理响应≤3秒；并发支持≥50
- 兼容性约束：支持微信小程序基础库2.10.0+，适配iOS 14+/Android 10+/平板横向布局，核心按钮宽度70%
- AI约束：自有多模态AI模型适配6大阶段专项验收，仅识别对应阶段问题，问题严重程度有明确量化阈值
- 落地约束：所有核心功能覆盖正向流程+异常场景，PRD与V15.3原型1:1对齐，功能ID/页面元素无歧义
- 原型约束：视觉规范（色值/字体/按钮尺寸）、交互规范（动效/Toast/加载）与V15.3原型完全一致
- 提醒约束：支持1/2/3/5/7天自定义提醒，前置阶段未通过则后续提醒自动暂停

## 二、全量页面功能需求
### 2.1 页面清单（全量38个核心页面，与V15.3原型严格对齐）
| 页面标识 | 页面名称（原型对齐）     | 所属模块         | 核心关联功能（对齐V15.3）                                    |
| :------- | :----------------------- | :--------------- | :----------------------------------------------------------- |
| **P01**  | **引导页**               | 引导页模块       | 新用户品牌引导、核心能力展示、权限初始化，3张滑动引导图，主按钮「开始使用」 |
| **P02**  | **首页（优化版）**       | 首页模块         | 核心功能4宫格、6大阶段快捷入口、水滴状城市定位入口、会员权益引导、Tabbar（首页/施工陪伴/我的） |
| **P03**  | **公司名称输入页**       | 公司风险检测模块 | 公司名称输入、拼音首字母模糊匹配、历史记录、手动提交检测     |
| **P04**  | **检测中/分析中页**      | 通用流程模块     | 实时进度展示、进度条（主色#007AFF）、超时重试功能            |
| **P05**  | **报价单上传页**         | 报价单分析模块   | 文件上传（PDF/JPG/PNG，≤10MB）、示例查看、断点续传           |
| **P06**  | **报价单分析结果预览页** | 报价单分析模块   | 核心风险展示、预估省钱金额、解锁完整报告入口                 |
| **P07**  | **合同上传页**           | 合同审核模块     | 文件上传、合规范本示例、未检测公司红色提示条                 |
| **P08**  | **合同审核结果预览页**   | 合同审核模块     | 核心风险条款展示、修正建议数、解锁完整报告入口               |
| **P09**  | **施工陪伴页（核心页）** | 施工陪伴模块     | 6大阶段管理、开工日期设置、提醒设置、特殊申请（自主装修豁免/争议申诉）、阶段时间校准 |
| **P10**  | **个人中心页**           | 个人中心模块     | 报告/照片/订单管理、装修日历入口、数据管理、专属客服         |
| **P11**  | **公司风险报告详情页**   | 报告模块         | 工商信息、风险详情、PDF导出、分享功能                        |
| **P12**  | **报价单分析报告详情页** | 报告模块         | 漏项/虚高分析、本地市场价对比、PDF导出                       |
| **P13**  | **合同审核报告详情页**   | 报告模块         | 全量条款分析、修正建议、合规范本、PDF导出                    |
| **P14**  | **消息中心页**           | 通用模块         | 施工提醒/报告通知/系统消息分类、未读红点、批量操作           |
| **P15**  | **验收照片页（通用）**   | 通用模块         | 强制竖拍、AI辅助裁剪、相册选择、最多9张照片、阶段专属拍摄指引 |
| **P16**  | **使用指南页**           | 通用模块         | 功能操作指引、常见问题、分类标签、搜索功能                   |
| **P17**  | **隐私保障页**           | 通用模块         | 数据收集/使用/存储规则、隐私异议反馈                         |
| **P18**  | **报告汇总页**           | 个人中心子模块   | 施工/分析类报告归档、筛选、预览、导出                        |
| **P19**  | **账户与通知设置页**     | 设置模块         | 账户信息、提醒开关、提醒提前天数自定义、权限管理             |
| **P20**  | **数据管理页**           | 个人中心子模块   | 施工照片/报告批量管理、回收站（会员专属）                    |
| **P21**  | **回收站页**             | 个人中心子模块   | 已删除数据恢复、永久删除、会员7天恢复期                      |
| **P22**  | **意见反馈页**           | 通用模块         | 反馈类型选择、内容输入、凭证上传                             |
| **P23**  | **客服中心页**           | 通用模块         | AI智能解答优先、人工客服双入口、快捷回复、图文/照片沟通、转人工       |
| **P24**  | **我的订单页**           | 订单模块         | 订单筛选、详情查看、电子发票入口                             |
| **P25**  | **订单详情页**           | 订单模块         | 订单信息展示、退款申请、监理服务预约                         |
| **P26**  | **会员权益页**           | 付费模块         | 会员套餐展示、开通/续费、核心权益列表                        |
| **P27**  | **报告解锁确认页**       | 付费模块         | 单份解锁/会员开通选择、权益对比                              |
| **P28**  | **支付页**               | 付费模块         | 微信支付、解锁结果反馈、已解锁权益展示                       |
| **P29**  | **装修日历页**           | 个人中心子模块   | 6大阶段计划/验收节点日历视图、月周切换、图例、「前往阶段」跳转P09 |
| **P30**  | **阶段验收/台账页**      | 施工陪伴子模块   | 6大阶段验收结果展示、整改/复检、申诉、AI监理咨询、分享报告跳转（V2.6.7优化）             |
| **P32**  | **报告分享页**           | 分享功能        | 报告分享卡片预览、微信分享功能、分享积分奖励（V2.6.7新增）                                |
| **P33**  | **积分记录页**           | 用户中心        | 积分汇总展示、积分明细列表、积分规则说明（V2.6.7新增）                                    |
| **P31**  | **验收/核对指引弹窗**    | 施工陪伴子模块   | 阶段验收要点、拍摄指引、合格判定标准                         |
| **P32**  | **分享页**               | 施工陪伴子模块   | 进度/报告分享、微信好友/朋友圈/图片保存                      |
| **P33**  | **网络异常页**           | 通用异常模块     | 断网提醒、重新加载、返回首页                                 |
| **P34**  | **退款申请页**           | 订单模块         | 退款原因选择、说明输入、提交审核                             |
| **P35**  | **城市选择页（原型版）** | 通用模块         | 城市定位、热门城市推荐、省份-城市选择、搜索功能              |
| **P36**  | **AI监理咨询页**         | 监理咨询模块     | 基于验收上下文聊天、转人工监理、咨询记录                     |
| **P37**  | **材料进场人工核对页**   | 施工陪伴子模块   | 材料清单校验、资料核查、实物拍照、核对结果提交               |
| **P38**  | **城市选择页（补充版）** | 通用模块         | 定位提示区、城市搜索、省份-城市联动选择、确认按钮            |

### 2.2 各页面详细功能需求（与V15.3原型1:1对齐）
#### 2.2.1 引导页（P01）
**原型对齐要点**：全屏纯白背景，3张滑动引导页，底部圆点指示器（选中态#007AFF），右上角「跳过」，主按钮「开始使用」，无Tabbar/状态栏。
| 功能ID | 功能名称   | 需求描述（对齐V15.3）                                        | 交互规则                                                     | 异常场景处理                                                 |
| :----- | :--------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| FR-001 | 引导页展示 | 展示品牌图标（80rpx×80rpx）、主副标题、3项核心能力（图标+文字）、主按钮「开始使用」 | 垂直居中布局，间距30rpx；页1：品牌介绍，页2：6大阶段标准化施工，页3：智能双重提醒 | 无网络：正常展示，跳转后触发P33网络异常页                    |
| FR-002 | 滑动切换   | 左右滑动切换引导页，切换后3秒倒计时重置，点击页码指示器直接跳转 | 滑动动效0.2s左右滑动，页码指示器切换带0.2s淡入动效           | 滑动卡顿：简化动效，保留基础切换功能                         |
| FR-003 | 跳转逻辑   | 点击「跳过」/「开始使用」或倒计时结束→跳转P02，本地缓存`onboarding_completed=true` | 跳转后自动弹出「进度+消息提醒权限请求弹窗」，含「允许」「拒绝」按钮，底部提示「拒绝后可在【我的-设置】二次开启」 | 权限拒绝：不影响首页使用，仅关闭微信服务通知，保留小程序内提醒 |
| FR-004 | 可点击动效 | 所有可点击元素（开始使用/跳过）点击带0.1s按压缩放动效（scale=0.95） | 动效一致，无额外延迟                                         | -                                                            |

#### 2.2.2 首页（优化版，P02）
**原型对齐要点**：含Tabbar（底部88rpx），顶部水滴状城市定位入口（40rpx×36rpx，背景#007AFF），右侧消息提醒图标（未读红点8rpx#FF3333），核心功能4宫格，6大阶段横向滑动入口。
| 功能ID | 功能名称        | 需求描述（对齐V15.3）                                        | 交互规则（对齐V15.3）                                        | 异常场景处理                                     |
| :----- | :-------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------- |
| FR-005 | 城市定位入口    | 水滴状入口显示当前城市简称（如“深”），未选择时显示“定位”，背景#007AFF，文字24rpx#FFFFFF | 点击→跳转P38城市选择页；城市切换后实时更新入口文字；点击带0.1s背景加深动效（#0066CC） | 定位失败：入口显示“定位”，点击跳转手动选择       |
| FR-006 | 消息提醒图标    | 40rpx图标，有未读提醒时右上角加8rpx红色红点（#FF3333），距右侧20rpx | 点击→跳转P14消息中心页，未读红点自动消除                     | -                                                |
| FR-007 | 核心功能4宫格   | 90%宽居中，卡片式布局，4个卡片（装修公司检测/报价分析/合同审核/AI施工验收），含40rpx图标+28rpx文字#333333 | 点击对应卡片跳转至对应功能页（AI施工验收→P09）；点击带0.1s按压缩放动效 | 跳转失败：提示“功能暂不可用，请稍后再试”         |
| FR-008 | 6大阶段快捷入口 | 90%宽、120rpx高，横向可滑动（无滚动条），每个阶段卡片（60rpx×60rpx图标+24rpx文字#333333），待提醒阶段加8rpx红色红点 | 点击对应阶段→跳转P09该阶段详情区域；滑动无卡顿，动效流畅     | 无阶段数据：入口置灰，点击提示“请先设置开工日期” |
| FR-009 | 轮播图展示      | 100%宽、200rpx高，懒加载，3张图片（6大阶段介绍/智能提醒/会员权益），底部圆点指示器 | 自动轮播3秒/张，手动滑动暂停自动轮播；单张图片≤200KB         | 图片加载失败：显示占位图，提示“图片加载失败”     |
| FR-010 | 会员权益金卡    | 90%宽、80rpx高，圆角16rpx，背景线性渐变#FFCC00，左侧文字「6大阶段全报告解锁+无限次AI提醒」，右侧「立即开通」 | 点击“立即开通”→跳转P26会员权益页；文字24rpx#333333，按钮文字24rpx#007AFF | -                                                |

#### 2.2.3 施工陪伴页（核心页，P09，V2.6.2优化版）
**原型对齐要点**：含Tabbar，顶部开工日期设置区，全局进度概览，6大阶段卡片（按S00-S05顺序，简化后），底部「一键分享进度」按钮，待提醒阶段卡片右上角加8rpx红色红点。

**V2.6.2优化说明**：
- **删除功能**：进度偏差提醒栏（信息已在全局进度概览中显示）、记录板块展开/折叠交互、记录板块中的"标记整改"和"申请复检"按钮、导航栏"特殊申请"入口（移至设置页）
- **简化功能**：阶段卡片删除重复时间信息、记录板块仅保留"查看台账/报告"按钮（已完成阶段显示）、操作按钮简化
- **优化交互**：页面更简洁，操作路径更短，核心功能更突出
| 功能ID | 功能名称     | 需求描述（对齐V15.3）                                        | 交互规则（对齐V15.3）                                        | 异常场景处理                                                 |
| :----- | :----------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| FR-011 | 开工日期设置 | 点击「编辑」弹出微信原生日期选择器（含7/15/30天快捷选择），未设置显示「设置开工日期」主按钮（#007AFF） | 确认后后端按行业周期自动计算6大阶段预计开始/验收时间，Toast提示「进度计划更新成功」；未设置则所有阶段卡片置灰 | 日期选择异常：保留原日期，提示「选择失败，请重新操作」       |
| FR-012 | 阶段卡片展示 | 每个卡片含：阶段图标、名称（32rpx#333333）、状态角标、计划时间、进度条、操作区（核心按钮+校准时间+已完成按钮） | 进度条颜色：待开始（灰#EEEEEE）、进行中（#007AFF）、已完成（#00CC66）、延期（橙#FF9900）；S00操作区：「人工核对」「核对指引」，S01-S05：「AI验收」「验收指引」 | 阶段加载失败：提示「进度加载失败，点击重试」                 |
| FR-012a | S00入口管控（V2.6.3新增） | 未上传报价单/合同时，S00「人工核对」按钮置灰不可点击 | 预拉材料清单，清单为空→按钮置灰；点击时若清单为空→Toast「请先上传报价单以获取材料清单」；上传报价单后返回P09自动刷新 | 清单加载失败：按钮置灰，点击提示「请先上传报价单」           |
| FR-013 | 流程互锁规则 | S00人工核对通过→解锁S01 AI验收；前置阶段未通过→后续阶段按钮置灰；**V2.6.5**：复检3次仍未通过的阶段显示「待整改」，但可解锁下一阶段（rectify_exhausted） | 点击置灰按钮→Toast提示「请先完成XX阶段验收/核对」；无绕过可能，后端同步校验 | -                                                            |
| FR-014 | 智能提醒设置 | 点击开工日期旁「提醒设置」→弹出弹窗（90%宽、60%高），含「智能提醒总开关」「提醒提前天数」（1/2/3/5/7天） | 设置实时同步后端+P19，双向同步；点击「保存设置」→Toast提示「提醒设置成功」 | 设置失败：保留原设置，提示「设置未生效，请重试」             |
| FR-015 | 阶段时间校准（V2.6.2优化：文案改为"调整时间"） | 点击「调整时间」→弹出微信原生日期选择器，手动修改预计验收时间（仅in_progress/pending状态显示） | 修改后后端重新计算提醒时间，Toast提示「时间调整成功，提醒同步更新」；手动时间优先级高于系统计算 | 校准时间冲突（早于开工日期）：提示「调整时间需晚于开工日期，请重新选择」 |
| FR-016 | 特殊申请入口（V2.6.2优化：移至设置页） | 「我的-设置」页新增「特殊申请」入口→弹出「自主装修豁免/核对验收争议申诉」下拉菜单 | 自主装修豁免：提交申请（装修类型+原因≥10字）→1-2个工作日审核，通过后阶段卡片标注「自主装修豁免」绿色标识；争议申诉：提交异议阶段+原因+凭证≤3张照片→审核通过后重新生成台账/报告 | 申请提交失败：提示「网络异常，请稍后重试」，保留输入内容     |
| FR-017 | 进度分享功能 | 底部主按钮「一键分享进度」→跳转P32，自动携带6大阶段进度+提醒状态+开工日期 | 按钮线性渐变#007AFF，88rpx高，圆角16rpx，点击带0.1s按压缩放动效 | 无进度数据：提示「暂无施工进度可分享，请先设置开工日期」     |
| FR-018 | 记录板块（V2.6.2优化：简化，删除展开/折叠） | 卡片底部记录板块：已完成阶段显示「查看台账/报告」按钮，其他状态显示状态文字（待人工核对/待验收/待整改） | S00点击「查看台账」→跳转P37，S01-S05→跳转P30；标记整改和申请复检功能移至P30验收详情页 | -                                                            |

#### 2.2.4 材料进场人工核对页（P37，V2.6.3优化）
**原型对齐要点**：无Tabbar，顶部导航栏（左侧返回箭头，中间标题「材料进场人工核对」），材料清单区域（每项可勾选+拍照留证），底部双按钮（「核对未通过」/「核对通过」）。**V2.6.3**：材料清单支持勾选确认，每项独立拍照；清单为空时引导先上传报价单；P09入口管控，未上传报价单不允许进入。
| 功能ID | 功能名称      | 需求描述（对齐V15.3）                                        | 交互规则（对齐V15.3）                                        | 异常场景处理                                                 |
| :----- | :------------ | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| FR-019 | 材料清单加载  | 页面加载时自动同步P05/P07上传的报价单材料清单，按「关键材料→辅助材料」排序，每项含：勾选框、名称、规格/品牌、数量、「拍照留证」按钮 | 材料项卡片式布局（白色背景、圆角20rpx），项间距12rpx；未上传照片显示“待上传”22rpx#FF9900，已上传显示80rpx×80rpx缩略图（最多3张） | 清单为空：显示「未同步到材料清单，请先上传报价单」，含「去上传报价单」按钮→P05 |
| FR-020 | 勾选与拍照    | 每项材料支持：①勾选确认 ②拍照留证（每项至少1张，最多3张）。关键材料须全部勾选且每项至少1张照片 | 点击勾选框切换；点击「拍照留证」→相机/相册→上传后缩略图展示，支持删除重传 | 拍照模糊：建议重拍（非强制）                                 |
| FR-021 | 资料核查功能  | 资料核查模块含「出厂合格证」「质保书」「CCC认证」3项，每项右侧「上传凭证」按钮，已上传则勾选框变为#007AFF对勾 | 关键材料（钢筋/水泥）未上传资料→弹出「关键材料需上传质保文件，否则无法通过核对」提示，强制补充 | 资料格式错误：提示「仅支持PDF/JPG格式，文件≤10MB」           |
| FR-022 | 问题标注输入  | 浅橙#FFF7E5背景卡片，输入框提示文字「如有材料不符，请简要描述」，最多输入100字 | 输入框高度80rpx，文字24rpx#999999                            | 输入超限：实时提示「已超出100字」，禁止继续输入              |
| FR-023 | 核对结果提交  | 点击「核对通过」→校验：所有关键材料已勾选且每项至少1张照片→跳转P09，S00更新为「已核对」；点击「核对未通过」→填写原因≥10字→跳转P09，S00为「待整改」 | 未达标时「核对通过」置灰，Toast提示具体缺项；提交成功后Toast「核对通过，S01-S05已解锁」 | 提交失败：保留已输入内容，提示「网络异常，请稍后重试」       |

#### 2.2.5 阶段验收/台账页（P30）
**原型对齐要点**：无Tabbar，顶部导航栏（左侧返回箭头，右侧根据解锁状态显示「解锁报告」或「PDF导出」+「申诉」），验收概览卡片，验收详情列表（未解锁时部分预览），不合格项整改区，功能操作区，底部「返回施工陪伴」按钮。
**V2.6.4 优化（已实施）**：先解锁后导出；未解锁时展示1-2个真实问题激起解锁欲望；**删除「标记整改」「完成整改」**；申请复检弹窗上传照片；**删除施工照片区（方案A）**，施工照片统一在「我的数据」查看（区分验收照片与整改照片）；**申请复检与咨询AI监理并列**，咨询AI监理按钮黄色（#FFB800）。
**V2.6.5 优化（已实施）**：**解锁规则**：同一阶段验收报告解锁一次，复检不重复收费；**复检次数限制**：每阶段最多申请复检3次，超限后隐藏「申请复检」、展示「复检次数已用完」；**3次后自动进入下一阶段**：复检3次仍未通过时，阶段状态置为「待整改」但可解锁下一阶段；**施工陪伴页**：该阶段显示「待整改」。
| 功能ID | 功能名称       | 需求描述（对齐V15.3）                                        | 交互规则（对齐V15.3）                                        | 异常场景处理                                                 |
| :----- | :------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| FR-024 | 验收结果展示   | 验收概览含状态标签（已通过#00CC66/待复检#FF9900/未通过#FF3333）、**验收时间**（后端 `created_at`）、**未通过时风险等级**（后端 `severity`：高→高风险#FF3333、中→中风险#FF9900、低→低风险#00CC66）、核心数据（验收项数/合格数/不合格数）；**解锁状态**使用后端 `is_unlocked`（非本地假数据） | 验收详情列表按严重程度排序；**未解锁时**：展示1-2个真实不合格项（标题+简短描述）+数量提示，其余遮蔽，引导「解锁后可查看全部」；**已解锁时**：全量展示，每条含「查看详情」弹窗 | 数据加载失败：显示骨架屏（0.8s渐变动效），加载失败提示「点击重试」 |
| FR-025 | 整改/复检功能  | **申请复检**：点击→弹窗「上传整改照片（最多5张）」→逐张上传→提交→自动触发AI复检；**最多3次**，展示「还可申请复检 X/3 次」；第3次提交前提示「本次为最后一次复检机会」；3次后展示「复检次数已用完」，隐藏申请复检按钮；**解锁规则**：同一阶段解锁一次，复检不重复收费 | 整改区「申请复检」「咨询AI监理」并列；复检3次仍未通过→自动置阶段为「待整改」且可进入下一阶段，P09显示「待整改」 | 复检上传失败：提示「照片上传失败，请重新选择」；复检次数超限：提示「复检次数已达上限」               |
| FR-025a | 标记为已通过功能（V2.6.8新增） | **条件**：复检3次失败后（rectify_exhausted状态），且风险等级为低/中风险（非高风险）；**流程**：点击「标记为已通过」→弹窗（风险提示+说明文字输入≥20字+上传说明照片≥1张）→提交→状态改为「已通过」，可进入下一阶段；**限制**：高风险问题必须通过申诉流程，无法直接标记 | 复检3次失败后，整改区显示「标记为已通过」按钮（仅低/中风险显示）和「咨询AI监理」按钮；弹窗含风险提示「我已确认当前阶段施工质量符合要求，愿意承担后续风险」 | 高风险问题：提示「高风险问题必须通过申诉流程，无法直接标记为已通过」；说明文字不足：提示「说明文字至少20字」；照片不足：提示「请上传至少1张说明照片」 |
| FR-026 | 申诉功能（V2.6.7优化） | **位置调整**：申诉按钮从导航栏移至底部操作区，与「分享报告」「返回」并列；仅在验收未通过且未申诉时显示；申诉中显示「申诉中」灰色按钮 | 点击→弹出申诉弹窗（异议原因输入框+凭证上传区），提交后→Toast提示「申诉已提交，1-2个工作日审核」，P09对应阶段卡片显示「申诉中」红色小标签 | 申诉提交失败：保留输入内容/凭证，提示「网络异常，请重试」    |
| FR-026a | 分享功能优化（V2.6.7新增） | **分享流程**：点击「分享报告」按钮跳转到P32报告分享页；用户在分享页点击右上角分享给好友/朋友圈；分享完成后返回分享页时自动检测并发放积分奖励；每日同一类型分享仅奖励一次 | 底部操作区「分享报告」为主按钮（60%宽度，渐变蓝色），显示「📤 分享报告 +10积分」；点击后跳转P32报告分享页；分享页支持微信原生分享功能，分享成功后返回时自动调用`POST /points/share-reward`接口，Toast提示「分享成功，获得10积分！」 | 积分奖励失败不影响分享功能，静默失败；分享页支持下拉刷新重新检测积分奖励    |
| FR-027 | AI监理咨询入口 | 整改区「咨询AI监理」按钮（黄色#FFB800），已通过时功能操作区右侧显示；**合并原「预约人工监理」** | 点击→携带当前报告ID、阶段、问题列表跳转P36；P36内提供「AI无法解决？转人工监理」入口，先AI咨询再转人工 | 用户未登录：弹出登录引导弹窗→微信快捷登录                    |
| FR-028 | 解锁与PDF导出  | **先解锁后导出**：未解锁时导航栏显示「解锁报告」→跳转P27；已解锁时显示「PDF导出」→生成PDF | 未解锁：点击「解锁报告」→P27付费（9.9元/份或会员免费）；已解锁：点击「PDF导出」→生成PDF（命名「[阶段名]验收报告-[用户名]-[日期].pdf」） | PDF生成失败：提示「生成失败，请稍后重试」                    |
| FR-028a | 功能操作区简化（V2.6.4） | **删除「保存报告」**（无实质逻辑）；保留「分享」；未通过/待复检时「咨询AI监理」已移至整改区并列「申请复检」，已通过时保留「咨询AI监理」 | 分享→微信好友/朋友圈；咨询AI监理→P36（整改区/功能区，黄色按钮） | - |

#### 2.2.6 智能提醒核心关联功能（P09/P14/P19）
| 功能ID | 功能名称     | 需求描述（对齐V15.3）                                        | 交互规则（对齐V15.3）                                        | 异常场景处理                                 |
| :----- | :----------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :------------------------------------------- |
| FR-029 | 订阅授权弹窗 | 首次进入P09→弹出微信「长期订阅/一次性订阅」授权弹窗，标题「装修智能提醒」，描述「6大阶段开始/验收前3天将推送微信服务通知」 | 授权后不再弹出，拒绝后仅保留小程序内提醒（消息中心+页面红点）；P19支持重新授权 | 授权失败：无额外弹窗，仅保留小程序内提醒     |
| FR-030 | 提醒联动规则 | 前置阶段未通过→后续阶段提醒自动暂停；阶段状态=已完成→提醒永久失效；手动校准时间→提醒时间同步刷新 | 提醒暂停时，P09对应阶段卡片标注「提醒暂停」灰色小字；恢复提醒→Toast提示「XX阶段提醒已恢复」 | 规则同步失败：提示「提醒设置未同步，请重试」 |
| FR-031 | 消息中心同步 | 施工提醒消息分类→点击→直达P09对应阶段卡片，自动消除未读红点；未读红点同步P02消息图标 | 消息按时间倒序排列，未读消息右上角8rpx红色红点；批量操作支持「标为已读」「删除已选」（施工提醒不可删除） | 消息加载失败：提示「消息加载失败，点击重试」 |

### 2.3 新增页面补充（P37/P38，对齐V15.3原型）
#### 2.2.7 城市选择页（P38）

#### 2.2.8 客服中心页（P23，V2.6.6 双入口优化）
**页面定位**：专属客服/在线客服统一入口，AI 智能解答优先，解决不了转人工。

**双入口设计**：
| 入口       | 说明                         | 能力                                       |
| :--------- | :--------------------------- | :----------------------------------------- |
| AI 智能解答 | 默认 Tab，24/7 快速响应      | 对接 AI 咨询接口，支持文字+图片，解答报告解锁、验收规范、会员权益、退款政策等 |
| 人工客服   | 工作日 9:00-18:00            | 快捷回复、图文沟通、会员优先接入、电话咨询  |

**交互规则**：
- 用户进入页面默认展示「AI 智能解答」Tab，可切换至「人工客服」
- AI 模式：与 AI 监理咨询相同能力（含照片上传、额度用尽提示），底部常驻「AI无法解决？转人工客服」，点击后切换至人工 Tab 并提示已转接
- 人工模式：保留原有快捷回复、聊天窗口、电话咨询
- 会员在人工模式下展示「会员专属客服，优先接入」提示
**原型对齐要点**：顶部导航栏（左侧返回箭头，中间标题「选择城市」），定位提示区（背景#EEF7FF），热门城市推荐区，城市搜索区，省份-城市选择区，底部「确认选择」按钮（90%宽、88rpx高，#007AFF）。
| 功能ID | 功能名称      | 需求描述（对齐V15.3）                                        | 交互规则（对齐V15.3）                                        | 异常场景处理                                     |
| :----- | :------------ | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------- |
| FR-032 | 自动定位功能  | 进入页面自动触发定位，定位中显示「定位中...」，成功显示「当前定位城市：[城市名]」（城市名高亮#007AFF），失败显示「定位失败，请手动选择城市」 | 定位成功→高亮显示当前城市，点击可直接选中；定位权限拒绝→隐藏定位城市，仅展示手动选择列表 | 定位超时：默认显示热门城市列表                   |
| FR-033 | 热门城市选择  | 热门城市标签横向排列（60rpx高、120rpx宽，白色背景、1rpx#EEEEEE边框），默认显示北京/上海/广州/深圳/杭州 | 点击→标签变为#007AFF边框+背景，底部确认按钮高亮；再次点击其他城市→自动切换选中状态 | -                                                |
| FR-034 | 省份-城市联动 | 左侧省份列表（占30%宽，背景#F5F5F5），右侧城市列表（占70%宽，背景#FFFFFF），初始选中「广东省」 | 点击左侧省份→右侧实时刷新对应城市；点击右侧城市→文字变为#007AFF+背景#EEF7FF，确认按钮高亮 | 城市加载失败：提示「城市列表加载失败，点击重试」 |
| FR-035 | 城市搜索功能  | 搜索框支持输入城市名/拼音，实时筛选匹配结果，无结果显示「未找到相关城市」 | 搜索结果显示在搜索框下方，点击可直接选中；清空输入→恢复热门城市+省份-城市选择区 | 搜索无结果：提示「未找到相关城市，请重新输入」   |
| FR-036 | 确认选择逻辑  | 点击「确认选择」→保存城市至本地缓存+后端，返回上一页，弹出Toast提示「已切换至[城市名]，后续AI分析基于该城市规范」 | 未选中城市时按钮置灰#CCCCCC，不可点击；网络异常→保存失败，提示「城市保存失败，请检查网络」 | -                                                |

#### 2.2.9 装修日历页（P29 日历视图，方案A已实施）
**页面定位**：装修进度日历可视化，展示6大阶段计划/实际/延期节点，P10「装修日历」跳转目标页；方案A：完整6阶段节点计算、月/周视图、图例、「前往阶段」跳转P09。

**原型对齐要点**：无Tabbar，顶部导航栏（左侧返回箭头→P10，标题「装修日历」，右侧月视图/周视图标签），日历视图区（90%宽居中），节点标注色、底部图例、节点弹窗含「前往阶段」按钮。
| 功能ID | 功能名称     | 需求描述（对齐V15.3）                                        | 交互规则（对齐V15.3）                                        | 异常场景处理                                                 |
| :----- | :----------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| FR-037 | 日历视图展示 | 月视图默认：年月切换「上一月/下一月」、星期栏（日~六）、7列×6行日期格；周视图：当周7天横向排列；节点标注：开工#FF3333、计划#007AFF、已验收#00CC66、延期#FF9900 | 视图切换带0.2s淡入动效；日期格点击带0.1s按压缩放；底部图例展示4类节点颜色与含义 | 未设置开工日期：显示「设置开工日期后，将在此展示6大阶段计划与验收节点」+「去设置」→P09 |
| FR-038 | 6大阶段节点计算 | 基于开工日期与行业周期（S00 3天/S01 7天/S02 10天/S03 7天/S04 7天/S05 5天）计算每阶段计划开始/计划验收日；已验收阶段显示「已验收」，逾期未完成显示「延期」 | 节点实时同步P09开工日期、阶段状态、校准时间；数据来源：GET /constructions/schedule 或本地 storage | 接口失败：使用本地 storage 兜底，保证日历可展示 |
| FR-039 | 节点详情弹窗 | 点击有节点的日期→弹出弹窗（90%宽居中），显示日期、节点列表（阶段名称+节点类型）、「前往阶段」按钮 | 点击「前往阶段」→写入 storage `calendar_go_to_stage_index`，跳转P09施工陪伴页，P09 useDidShow 读取后滚动到对应阶段卡片并高亮 | 无阶段关联（如仅开工日）：前往阶段仍跳转P09，不滚动 |
| FR-040 | 数据同步规则 | 节点信息与P09开工日期、阶段状态、校准时间双向同步；P09修改后日历 useDidShow 自动刷新 | 日历页从 `/constructions/schedule` 或 `construction_start_date`/`construction_stage_status`/`construction_stage_calibrate` 加载 | -                                                            |

## 三、非功能需求（100%对齐V15.3原型）
1. **视觉规范一致性**：
   - 色值：主色#007AFF、成功色#00CC66、警示色#FF9900、危险色#FF3333、中性色#333333/#666666/#999999/#EEEEEE
   - 字体：标题≥32rpx（加粗）、正文28rpx、辅助文字24rpx、最小提示文字20rpx
   - 按钮：主按钮88rpx高、圆角16rpx、线性渐变#007AFF；次要按钮60rpx高、圆角16rpx、边框1rpx#007AFF；最小点击区域≥44rpx×44rpx
   - 卡片：圆角16rpx、阴影0 2rpx 8rpx rgba(0,0,0,0.1)、间距20rpx
   - 红点：8rpx纯红圆形#FF3333，位于元素右上角10rpx处，无数字
   - 弹窗：遮罩层rgba(0,0,0,0.7)（深色模式0.9），宽90%、居中，支持空白处/右上角×关闭
2. **交互规范一致性**：
   - 动效：弹窗0.2s淡入淡出、按钮点击0.1s按压缩放（scale=0.95）、页面切换0.2s左右滑动、折叠/展开0.2s平滑过渡
   - Toast：固定在胶囊按钮下方，背景rgba(0,0,0,0.8)、文字#FFFFFF、显示3秒，期间禁止重复触发
   - 加载：微信原生加载图标（60rpx×60rpx），搭配进度条（6rpx高、圆角3rpx、#007AFF）
   - 上传：支持断点续传、进度实时更新，单文件≤10MB，仅支持PDF/JPG/PNG
   - 拍照：强制竖拍，支持AI辅助裁剪、相册选择，最多9张，关联阶段专属拍摄指引
   - 流程互锁：未满足前置条件→按钮置灰#E5E5E5+不可点击+Toast提示前置要求
3. **数据/跳转规则**：
   - 页面跳转：所有跳转携带用户ID+阶段编号（如有）+操作参数，示例：P02→P09?uid=xxx&stage=S01
   - 数据同步：所有前端操作实时同步后端，后端返回状态码（200=成功/400=参数错误/403=权限不足/409=流程互锁）
   - 本地缓存：仅缓存非敏感信息（引导页完成标记、红点状态），敏感信息（开工日期、阶段状态）仅从后端拉取
   - 兜底处理：网络异常跳转P33、空数据显示专属空视图、操作超时显示「点击重试」
4. **性能/兼容性**：
   - 页面加载≤1.5秒，AI验收分析≤10秒，AI监理响应≤3秒，并发支持≥50
   - 支持微信小程序基础库2.10.0+，适配iOS 14+/Android 10+/平板横向布局
   - 深色模式适配：所有页面元素色值、遮罩层透明度按原型要求调整

## 四、版本差异说明（V2.6.1原版本→对齐V15.3原型版）
| 模块       | 原V2.6.1状态           | 对齐后更新内容                                               | 原型对齐点                   |
| :--------- | :--------------------- | :----------------------------------------------------------- | :--------------------------- |
| 核心逻辑   | S00材料进场AI核对      | 改为人工核对，新增P37材料进场人工核对页，流程互锁规则同步调整 | 阶段操作、页面布局、核对逻辑 |
| 页面数量   | 36个核心页面           | 新增P37材料进场人工核对页、P38城市选择页（补充版），页面标识同步更新 | 页面清单、标识、所属模块     |
| 智能提醒   | 仅支持基础提醒开关     | 新增提醒提前天数自定义（1/2/3/5/7天）、三重触达、联动暂停规则 | 提醒弹窗、触发逻辑、状态同步 |
| 视觉交互   | 部分页面未统一规范     | 所有页面色值/字体/按钮/动效与V15.3原型完全一致               | 视觉规范、交互动效、弹窗样式 |
| 施工陪伴页 | 阶段卡片操作按钮不一致 | 统一阶段卡片结构，S00显示「人工核对」「核对指引」，S01-S05显示「AI验收」「验收指引」 | 按钮名称、布局、交互逻辑     |
| 验收页     | 无申诉功能/AI监理入口  | 新增验收申诉功能、AI监理咨询入口，跳转逻辑对齐原型           | 按钮位置、弹窗样式、跳转路径 |

## 五、附录（对齐V15.3原型）
1. 原型文档版本：装修决策Agent 微信小程序原型文档（V15.3）；
2. 页面映射表：PRD页面标识P01-P38与原型页面ID 1-38一一对应；
3. 功能ID映射：FR-001至FR-XXX与原型交互点ID完全匹配；
4. 本地化知识库版本：2026Q1版（覆盖337个地级市装修验收规范）；
5. 动效规范附录：所有交互动效严格遵循原型标注（弹窗淡入淡出、按钮按压缩放等）；
6. 视觉规范附录：所有页面元素尺寸、色值、字体与原型视觉规范一致（基准尺寸375×667，rpx弹性单位）。

## 六、核心业务闭环规则（对齐V15.3原型）
### 6.1 6大阶段互锁规则
1. 前置解锁条件：
   - S00材料进场：无前置条件，人工核对通过→状态「已核对」，解锁S01；
   - S01隐蔽工程：S00=已核对，AI验收通过→状态「已通过」，解锁S02；
   - S02泥瓦工：S01=已通过，AI验收通过→解锁S03；
   - S03木工：S02=已通过，AI验收通过→解锁S04；
   - S04油漆：S03=已通过，AI验收通过→解锁S05；
   - S05安装收尾：S04=已通过，AI整体验收通过→流程结束。
2. 状态流转规则：
   - 未开始→进行中→未通过/已通过→已完成；
   - 未通过→申请复检（上传整改照片）→待复检→已通过/未通过；
   - 自主装修豁免用户：无需验收通过，可手动更新状态，标注「豁免」灰色标签。

### 6.2 智能提醒闭环规则
1. 触达方式：微信服务通知（点击直达阶段）+ 小程序消息中心（P14）+ P02/P09红点（8rpx#FF3333）；
2. 触发时机：阶段开始前N天、验收前N天（N=1/2/3/5/7天，用户自定义），后端每分钟扫描任务表；
3. 联动规则：前置阶段未通过→后续提醒暂停；阶段完成→提醒永久失效；校准时间→提醒同步刷新；
4. 权限规则：首次进P09弹微信订阅授权，拒绝后仅保留小程序内提醒，P19支持重新授权。

### 6.3 数据安全与管理规则
1. 存储期限：原始文件（照片/文档）默认存储1年，用户可在P19调整为6个月/3个月；会员删除后7天可恢复，普通用户不可恢复；
2. 数据删除：手动删除仅清除原始文件，分析结果脱敏保留；聊天记录存储6个月；
3. 隐私保障：AI分析自有部署，原始数据不出私有环境；用户授权后才可使用相机/相册/通知权限。

## 七、AI能力落地规范（对齐V15.3原型）
### 7.1 阶段化AI验收规范
1. 分析范围严格绑定阶段：
   - S00：材料人工核对，AI辅助生成台账；
   - S01：水电走线、防水施工、吊顶龙骨等隐蔽工程；
   - S02：瓷砖铺贴、墙面抹灰、地面找平、地漏安装；
   - S03：柜体制作、吊顶造型、门窗套安装；
   - S04：墙面刮腻子、刷漆、阴阳角顺直；
   - S05：洁具/厨具/灯具安装、收口处理。
2. 问题判定量化标准：
   - 高风险（#FF3333）：违反强制性条款，影响安全/整改成本＞5000元；
   - 中风险（#FF9900）：违反非强制性条款，影响体验/整改成本1000-5000元；
   - 低风险（#FFCC00）：轻微不规范，整改成本＜1000元。

### 7.2 AI监理对话规范
1. 上下文理解：记忆窗口≥10轮，关联当前验收阶段、问题、本地规范；
2. 回答边界：仅回答装修相关问题，不推荐公司/材料，不做法律判决；
3. 安全预警：识别承重墙开洞等重大风险→红色预警，建议转人工监理。

## 八、城市本地化知识库规范（对齐V15.3原型）
1. 核心内容：按地级市维度构建，含验收规范、主材/辅材市场价、合同范本、本地装修特点；
2. 更新频率：每月5日前更新市场价，新规范发布后7个工作日内更新知识库；
3. 调用规则：用户选择城市后自动调用对应知识库，定位失败默认匹配注册地；
4. 离线缓存：首次选择城市后自动缓存核心内容（≤500M），弱网/断网可调用。

## 九、积分系统规范（V2.6.7新增）

### 9.1 积分获取规则
| 积分来源 | 奖励积分 | 限制规则 | 说明 |
|---------|---------|---------|------|
| 分享报告 | +10积分 | 每日每类型仅1次 | 分享验收报告、报价单报告、合同报告等 |
| 分享进度 | +5积分 | 每日仅1次 | 分享施工进度到微信 |

**说明**：积分系统当前仅用于展示和激励分享，暂不实现积分使用功能，避免与会员权益冲突。

### 9.2 积分展示
- **P10"我的"页面**：头部显示积分徽章，点击跳转到积分记录页
- **P33积分记录页**：展示积分汇总和明细列表
- **分享奖励提示**：分享成功后显示积分奖励Toast提示

### 9.3 积分API接口
- `POST /api/v1/points/share-reward`：分享奖励积分
  - 请求参数：`share_type`（report/progress）、`resource_type`（acceptance/quote/contract等）、`resource_id`（资源ID）
  - 返回：`points`（总积分）、`reward_points`（本次奖励积分）、`already_rewarded`（是否已获得今日奖励）
- `GET /api/v1/points/records`：获取积分记录列表（分页）
  - 请求参数：`page`（页码）、`page_size`（每页数量）
  - 返回：积分记录列表（来源类型、描述、积分变动、时间）
- `GET /api/v1/points/summary`：获取积分汇总信息
  - 返回：`total_points`（总积分）、`month_points`（本月获得积分）

### 9.4 积分展示页面（V2.6.7新增）

#### 9.4.1 P32 报告分享页
- **页面定位**：报告分享卡片预览 + 微信分享功能入口
- **核心功能**：
  - 展示报告分享卡片（报告标题、品牌标识、分享说明）
  - 支持微信原生分享（分享给好友、分享到朋友圈）
  - 分享成功后自动检测并发放积分奖励
  - 显示积分奖励状态（已获得奖励时显示徽章）
- **交互流程**：
  1. 从P30验收报告页点击「分享报告」跳转
  2. 展示报告卡片预览和分享说明
  3. 用户点击右上角分享按钮完成分享
  4. 返回分享页时自动检测并发放积分
  5. 显示积分奖励提示

#### 9.4.2 P33 积分记录页
- **页面定位**：用户积分汇总和明细展示
- **核心功能**：
  - 展示用户总积分和本月获得积分
  - 展示积分明细列表（来源、描述、积分变动、时间）
  - 展示积分规则说明
  - 支持下拉刷新和上拉加载更多
- **视觉布局**：
  - 顶部积分卡片：总积分大号显示，本月获得积分小字提示
  - 积分明细列表：按时间倒序排列，显示来源类型、描述、积分变动（正数绿色，负数红色）
  - 积分规则：展示积分获取规则说明

#### 9.4.3 P10"我的"页面积分展示
- **位置**：页面头部用户信息区域，会员徽章下方
- **样式**：积分徽章（半透明背景，显示「积分 XX」），可点击跳转到P33积分记录页
- **数据同步**：用户信息加载时自动包含积分字段，积分变动后实时更新

### 9.5 数据模型
- **User表**：新增`points`字段（INTEGER，默认0），存储用户总积分
- **PointRecord表**：积分记录表，记录所有积分变动
  - 字段：`id`（主键）、`user_id`（用户ID）、`points`（积分变动量，正数为增加，负数为减少）、`source_type`（来源类型）、`source_id`（关联资源ID）、`description`（描述）、`created_at`（创建时间）
  - 索引：`user_id`、`created_at`、`source_type`

## 十、AI监理咨询与收费规范（对齐V15.3原型）
### 9.1 服务定价与权益
| 服务类型             | 免费用户定价 | 会员用户权益                      | 备注                    |
| :------------------- | :----------- | :-------------------------------- | :---------------------- |
| 单份报告解锁         | 9.9元/份     | 无限次免费解锁                    | 仅支持「解锁本份」；3份套餐已下线 |
| 阶段化AI验收         | 9.9元/次     | 6大阶段无限次免费使用             | 全周期验收套餐49.9元    |
| AI监理咨询           | 9.9元/次     | 无限次免费咨询                    | 免费用户每月3次免费额度 |
| 人工监理线上咨询     | 49元/次      | 每月2次免费，超出后39元/次（8折） | 超时免费延长15分钟      |
| 装修全周期AI会员     | 199元/年     | 所有权益+专属客服+7天免费答疑     | 无有效期顺延，不退款    |
| 监理上门勘查（单次） | 199元/次     | 159元/次（8折）                   | 不含上门交通费          |

### 9.2 收费流程规范
1. 定价展示：所有价格醒目显示，套餐优惠明确标注立减金额，无隐形消费；
2. 支付确认：支付前弹出费用确认弹窗，标注服务名称、价格、权益、退款规则，用户勾选同意后触发支付；
3. 支付方式：仅支持微信支付，支付成功后即时解锁权益，失败则提示原因并保留选择状态。

### 9.3 商业闭环与支付落地（V2.6.2已实施）
1. **报告解锁**：用户点击「解锁本份报告」→ 前端调用 `POST /payments/create`（order_type=report_single, resource_type=company|quote|contract|acceptance, resource_id=对应ID）创建订单；会员用户若资源未解锁则直接返回 status=completed、order_id=0，无需支付；非会员弹出支付确认后调用 `POST /payments/confirm-paid`（开发/联调模拟支付成功），后端将订单置为已支付并设置资源 is_unlocked；前端跳转报告详情或验收页。生产环境应由微信支付回调执行相同权益发放逻辑。
2. **会员开通**：会员页选择月/季/年卡 → 跳转支付页（pkg=member_month|member_season|member_year）→ 前端调用 createOrder(order_type=对应会员类型) 创建会员订单 → 确认后调用 confirm-paid，后端更新用户 is_member、member_expire。
3. **支付页按来源分支**：支付页根据 URL 参数区分三种场景并展示对应内容与按钮：报告解锁（type+scanId）、会员开通（pkg=member_*）、订单去支付（order_id）；仅报告解锁展示单份 ￥9.9，不再展示 3 份套餐。
4. **解锁状态与后端同步**：报告详情页（合同/报价/公司）在拉取接口数据后优先使用接口返回的 is_unlocked 决定是否展示完整内容与 PDF 导出；本地 storage 仅作缓存或未登录兜底。
5. **订单列表「去支付」**：待支付订单点击「去支付」跳转支付页并携带 order_id；支付页拉取订单详情展示金额，用户确认后调用 confirm-paid(order_id) 完成支付并跳转订单列表。

## 十、V2.6.7 积分系统+UI优化更新说明（2026-02）

### 10.1 积分系统（新增）

#### 10.1.1 积分获取规则
- **分享报告**：每次分享验收报告/报价单报告/合同报告等，获得10积分，每日每类型仅奖励1次
- **分享进度**：分享施工进度到微信，获得5积分，每日仅1次
- **每日签到**：每日签到获得1积分（待实现）

#### 10.1.2 积分记录与查询
- **积分记录表**：记录所有积分变动（增加/减少），包含来源类型、关联资源ID、描述、时间
- **积分查询API**：
  - `GET /api/v1/points/records`：获取积分记录列表（分页）
  - `GET /api/v1/points/summary`：获取积分汇总（总积分、本月获得积分）

#### 10.1.3 积分与会员权益的关系（V2.6.7优化）
- **当前设计**：积分系统与会员权益完全独立，互不冲突
  - 积分：用于展示和激励分享，暂不实现使用功能
  - 会员：付费解锁所有报告，与积分无关
- **简单统一**：所有用户积分获取规则一致（分享报告+10积分，分享进度+5积分）
- **后续规划**：等积分系统稳定后，再考虑添加积分使用功能（如兑换会员体验等）

#### 10.1.3 数据模型
- **User表**：新增`points`字段（INTEGER，默认0）
- **PointRecord表**：积分记录表，字段包括：user_id, points, source_type, source_id, description, created_at

### 10.2 P30验收报告页UI优化

#### 10.2.1 顶部安全区域修复
- **问题**：导航栏内容被状态栏遮挡
- **解决方案**：导航栏增加安全区域处理（padding-top: max(44px, env(safe-area-inset-top))），确保所有内容完全可见

#### 10.2.2 申诉功能位置优化
- **原位置**：导航栏右上角（文字链接）
- **新位置**：底部操作区，与「分享报告」「返回」并列
- **样式**：白色背景，红色边框，显示「📝 申诉」；申诉中显示灰色「申诉中」按钮
- **优势**：更符合用户操作习惯，避免与PDF导出功能混淆

#### 10.2.3 分享功能优化
- **分享流程**：
  1. 用户点击「分享报告」按钮 → 跳转到P32报告分享页
  2. 分享页展示报告卡片预览和分享说明
  3. 用户点击右上角分享按钮 → 选择分享给好友或朋友圈
  4. 分享完成后返回分享页 → 自动检测并调用积分API发放奖励
  5. 成功获得积分后Toast提示「分享成功，获得10积分！」
- **按钮样式**：主按钮（60%宽度，渐变蓝色，显示「📤 分享报告 +10积分」）
- **防刷机制**：每日同一类型分享仅奖励一次，已获得奖励时显示「今日已获得分享奖励」
- **积分展示**：在P10"我的"页面头部展示用户积分徽章，点击可跳转到P33积分记录页

#### 10.2.4 底部操作区布局
- **分享报告**：主按钮（60%宽度，渐变蓝色`#007AFF`）
- **返回**：次要按钮（40%宽度，灰色背景`#f5f5f5`，边框`#e8e8e8`）
- **申诉**：可选按钮（仅在未通过且未申诉时显示，最小宽度120rpx，红色边框`#FF3333`）

---

## 十一、历史版本优化更新说明

### 11.1 V2.6.3 材料核对流程优化（2026-02）

#### 10.1.1 施工陪伴页 S00 入口管控
- 未上传报价单/合同时，「人工核对」按钮置灰，不可点击
- 页面加载时预拉材料清单（GET /material-checks/material-list），清单为空则按钮置灰
- 点击拦截：Toast「请先上传报价单以获取材料清单」
- 从报价单上传页返回 P09 时自动刷新材料清单状态

#### 10.1.2 材料进场人工核对页（P37）改造
- **材料清单**：从报价单/合同同步，每项含勾选框、名称、规格/品牌、数量、「拍照留证」按钮
- **勾选确认**：每项可勾选表示已逐项核对
- **逐项拍照**：每项独立拍照，每项最多3张，关键材料须全部勾选且每项至少1张照片才能「核对通过」
- **清单为空**：显示「未同步到材料清单，请先上传报价单或合同」+「去上传报价单」→P05
- **校验规则**：未达标时「核对通过」置灰，Toast 提示具体缺项

---

### 11.2 验收报告页（P30）优化（V2.6.4 已实施，V2.6.7 UI优化）

#### 10.2.1 解锁与导出流程
- **先解锁报告，才能PDF导出**：与公司/报价/合同报告一致，未解锁时仅显示「解锁报告」，不显示「PDF导出」
- **未解锁时**：顶部导航或操作区显示「解锁报告」主按钮，点击跳转 P27 报告解锁页（9.9 元/份或会员免费）
- **已解锁后**：显示「PDF导出」按钮，可直接生成 PDF

#### 10.2.2 未解锁时的预览策略（激起解锁欲望）
- **展示部分真实问题**：未解锁时展示 1～2 个真实不合格项（标题 + 简短描述），让用户感知「AI 确实发现了问题」
- **数量与风险提示**：展示不合格项总数（如「共 3 项不合格」）、存在高风险项等，制造紧迫感
- **遮蔽或折叠**：其余问题详情、整改建议、施工照片等需解锁后查看
- **引导文案**：如「解锁后可查看全部 X 项问题详情、整改建议及 PDF 导出」

#### 10.2.3 咨询入口合并与整改区简化（已实施）
- **预约人工监理 + 咨询AI监理 → 合并为「咨询AI监理」**：整改区删除「预约人工监理」
- **整改区简化**：删除「标记整改」「完成整改」；**申请复检** 点击后弹窗上传整改照片（最多5张）→提交→自动触发AI复检；**申请复检**与**咨询AI监理**并列展示，咨询AI监理按钮黄色（#FFB800）
- **施工照片区删除（方案A）**：本页不再展示施工照片，统一在「我的数据」中查看，施工照片分为「验收照片」（初次验收上传）与「整改照片」（复检时上传）
- **转人工逻辑**：在 P36 AI监理咨询页内提供「AI无法解决？转人工监理」入口，先 AI 咨询，解决不了再转人工

#### 10.2.4 保存报告与 PDF 导出
- **去除或改造「保存报告」**：当前「保存报告」无实质逻辑（仅 Toast），建议移除
- **PDF 导出即归档**：报告已在云端/「我的数据」可查看，PDF 导出 = 正式归档/分享，语义清晰

#### 10.2.5 与报告详情页一致性
- 验收报告页的解锁流程、预览策略应与 P11/P12/P13 报告详情页保持一致
- 统一「30% 预览 + 解锁后全量」的付费转化模式

---

### 10.3 V2.6.2 优化更新说明

### 10.1 代码架构优化

#### 10.1.1 API接口优化
**变更内容**：
- **删除冗余API**：移除 `/api/v1/materials/verify` 接口
- **统一接口规范**：材料进场核对统一使用 `PUT /api/v1/constructions/stage-status`（stage='S00', status='checked'）
- **影响范围**：前端代码已更新，使用 `constructionApi.updateStageStatus('S00', 'checked')` 替代原 `materialsApi.verify()`

**理由**：
- 避免API功能重叠，减少维护成本
- 统一使用施工进度API，逻辑更清晰

#### 10.1.2 新增材料库API
**新增接口**：
- `GET /api/v1/material-library/search` - 搜索材料库
- `GET /api/v1/material-library/common` - 获取常用材料
- `POST /api/v1/material-library/match` - 智能匹配材料（从报价单材料名称匹配材料库）

**数据库变更**：
- 新增 `materials` 表（材料库）
- 新增 `quotes.analysis_progress`、`contracts.analysis_progress` 字段（分析进度）
- 新增 `constructions.custom_durations` 字段（自定义阶段周期）

#### 10.1.2 前端实现说明
**当前状态**：
- **主版本**：`frontend/`（Taro框架）- 推荐使用
- **备用版本**：`miniprogram-native/`（原生小程序）- 保留作为备用

**建议**：
- 新功能开发优先在 `frontend/` 实现
- `miniprogram-native/` 仅用于紧急修复或特殊场景

---

### 10.2 用户体验优化（V2.6.2已实施）

#### 10.2.1 ✅ 首次使用体验优化（已实施）
**实现内容**：
- **首次报告免费**：用户首次使用任一功能（公司检测/报价单分析/合同审核），完整报告自动免费解锁
- **实现逻辑**：分析完成后，检查用户是否有其他已解锁的报告，如果没有则自动设置 `is_unlocked=True, unlock_type='first_free'`
- **新用户引导**：首次进入P02首页时，高亮显示"公司检测"入口（前端实现）

**目标**：提升首次使用转化率至>60%

#### 10.2.2 ✅ 付费转化优化（已实施）
**实现内容**：
- **分析进度提示**：AI分析过程中返回进度信息
  - 进度字段：`analysis_progress: {"step": "ocr|analyzing|generating|completed", "progress": 0-100, "message": "提示信息"}`
  - 前端可实时显示："正在识别文字..."（20%）→"正在分析风险..."（50%）→"生成报告中..."（90%）→"分析完成"（100%）
- **风险预览**：分析完成后，显示"发现X个风险项，解锁完整报告查看详情"（前端实现）

**目标**：提升付费转化率至>15%

---

### 10.3 商业模式优化（V2.6.2已实施）

#### 10.3.1 ✅ 会员权益优化（已实施）
**实现方案**：
- **会员无限解锁**：会员用户在创建订单时，如果资源未解锁，自动免费解锁（`is_unlocked=True, unlock_type='member'`）
- **会员价格配置**：
  - `MEMBER_MONTHLY_PRICE = 29.9` 元/月
  - `MEMBER_YEARLY_PRICE = 268` 元/年（年付优惠）
- **核心权益**：
  - ✅ **无限报告解锁**（已实现）
  - ✅ **AI监理咨询无限**（已有实现，`consultation.py` 中会员无限次）
  - ✅ **数据恢复30天**（需更新 `data_manage.py` 中的 `RECYCLE_DAYS = 30`）
  - ✅ **专属客服**（已有入口）

**目标**：提升会员续费率至>30%

#### 10.3.2 单次解锁优化
**优化内容**：
- **价格保持不变**：9.9元/份报告
- **增加价值感知**：解锁后显示"已为您节省约XXX元"（基于风险项预估，前端实现）

#### 10.3.3 ✅ 商业闭环与支付落地（已实施）
**实现内容**：
- **报告解锁**：解锁页仅展示「解锁本份报告 ￥9.9」；支付页调用 `POST /payments/create`（report_single + resource_type/resource_id）创建订单，会员直接免费解锁返回；非会员弹窗确认后调用 `POST /payments/confirm-paid` 模拟支付成功，后端更新订单状态并设置资源 is_unlocked（支持 company/quote/contract/acceptance）。
- **会员开通**：支付页识别 pkg=member_* 时展示会员套餐与金额，调用 createOrder(order_type=member_month|member_season|member_year) 创建订单，确认后调用 confirm-paid，后端更新 user.is_member、user.member_expire。
- **支付页分支**：按 type+scanId（报告解锁）、pkg=member_*（会员）、order_id（订单去支付）三种来源分别展示权益说明与主按钮，订单去支付时拉取订单详情展示金额。
- **报告详情解锁状态**：合同/报价/公司类型在请求详情接口后优先以返回的 is_unlocked 为准，本地 storage 作兜底。
- **订单列表去支付**：待支付订单跳转支付页带 order_id，支付页调用 confirm-paid(order_id) 完成支付后跳转订单列表。
- **后端接口**：`POST /payments/create` 支持 resource_type=company|quote|contract|acceptance 及会员订单类型；`POST /payments/confirm-paid` 统一处理报告解锁与会员开通的权益发放。

**说明**：生产环境需接入微信支付统一下单与回调，在回调中执行与 confirm-paid 相同的订单状态更新与权益发放逻辑；开发/联调阶段使用 confirm-paid 模拟支付成功。

---

### 10.4 功能优化（V2.6.2已实施）

#### 10.4.1 ✅ 阶段周期自定义（已实施）
**实现**：
- 用户在设置开工日期时可自定义各阶段周期
- API：`POST /api/v1/constructions/start-date` 支持 `custom_durations` 参数
- 格式：`{"S00": 3, "S01": 7, ...}`，未指定的阶段使用默认周期

#### 10.4.2 ✅ 材料库建设（已实施）
**实现**：
- 创建材料库数据表 `materials`
- API：`GET /api/v1/material-library/search`（搜索材料）
- API：`GET /api/v1/material-library/common`（常用材料）
- API：`POST /api/v1/material-library/match`（智能匹配）
- 初始化10种常用材料（水泥、瓷砖、电线等）

#### 10.4.3 ✅ 页面合并优化（已实施）
**实现**：
- ✅ P24/P25（订单列表/详情）合并：订单列表页支持下拉查看详情，无需跳转
- ✅ P18/P29（报告汇总/照片管理）合并：统一到"我的数据"页（`data-manage`），支持Tab切换
- ✅ P21回收站、P22意见反馈、P23在线客服：已移至"设置"内

**结果**：页面数量从38个减少到约30个核心页面

#### 10.4.4 ✅ 商业闭环补充（产品审视报告全部落地）
**实现**：
- **公司检测首次免费**：公司风险分析完成后，若该用户无任何已解锁报告（报价/合同/公司），自动将本条公司检测置 `is_unlocked=True, unlock_type='first_free'`。
- **监理服务订单+支付**：监理页（P26）选择单次/全流程套餐后点击「立即支付」→ 调用 `POST /payments/create`（order_type=supervision_single 或 supervision_package）创建订单 → 跳转支付页带 order_id，用户确认后调用 confirm-paid；后端 create_order 支持监理订单（无 resource），confirm-paid 仅更新订单状态。
- **单次解锁后推会员**：报告详情页在已解锁状态下展示「开通会员，全部报告无限解锁 →」跳会员页；解锁页（P27）主按钮下增加「开通会员，所有报告+验收报告无限解锁 →」跳会员页。
- **会员续费提醒**：`GET /users/profile` 响应增加 `member_expire`（会员到期日）；「我的」页会员 badge 展示「会员有效期至 YYYY-MM-DD」，若 7 天内到期或已过期展示「即将到期，请续费」/「已过期，请续费」；会员页同步展示到期日与剩余天数。
- **转介绍/邀请奖励**：进度分享页（P32）增加「邀请好友得1次免费报告解锁」区块，支持「复制邀请文案」；邀请奖励发放规则可后续对接后端与防刷。
- **支付回调**：`POST /payments/notify` 请求体解析 `out_trade_no`（测试可传 JSON；生产为微信 XML），按订单号查找订单后执行与 confirm-paid 相同的权益发放逻辑（`_grant_order_benefits`），确保微信回调与前端模拟支付结果一致。

---

### 10.5 技术指标优化

#### 10.5.1 性能指标
- **报告生成时间**：≤8秒（当前达标）
- **页面加载时间**：≤1.5秒（需持续监控）
- **AI验收分析**：≤10秒（当前达标）
- **AI监理响应**：≤3秒（当前达标）

#### 10.5.2 业务指标
- **首次使用转化率**：目标>60%（需数据验证）
- **付费转化率**：目标>15%（需数据验证）
- **会员续费率**：目标>30%（需数据验证）
- **功能使用率**：各功能使用率<5%的考虑下线或隐藏

---

### 10.6 版本兼容性说明

**向后兼容**：
- V2.6.2完全兼容V2.6.1的所有功能
- 已删除的API（`/materials/verify`）前端已更新，不影响现有用户

**升级建议**：
- 建议所有用户升级至V2.6.2
- 新用户直接使用V2.6.2版本

---

## 十一、项目落地与验收标准
1. **原型还原度**：所有页面、交互、元素与V15.3原型1:1还原，还原度≥99%；
2. **功能完整性**：实现PRD中所有功能ID，核心业务闭环（进度-验收-提醒-付费）正常运行；
3. **兼容性**：支持主流手机机型、微信不同版本，平板横向布局适配正常；
4. **性能达标**：页面加载≤1.5秒，AI分析响应时间符合要求，无明显卡顿；
5. **测试验收**：功能测试通过率≥99%，异常场景全覆盖，数据安全无泄露风险。

## 十一、附则
1. 本PRD为「装修避坑管家」微信小程序开发、测试、验收的唯一依据，所有参与方需严格遵守；
2. 后续更新需经产品负责人审批，更新后发布新版本，旧版本自动失效；
3. 开发过程中对PRD内容的理解产生争议时，由产品负责人裁定，裁定结果为最终结果；
4. 本PRD自发布之日起生效。

**编制人**：产品部
**编制日期**：2026年02月09日
**审批人**：XXX
**审批日期**：2026年02月09日

是否需要我帮你将这份对齐后的PRD整理成可编辑的Word文档，按章节分栏排版并标注功能ID与原型对齐点，方便直接交付开发团队？
